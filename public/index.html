<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wipple</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* BASE & LAYOUT */
        body { font-family: 'Inter', sans-serif; background-color: #212121; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #2d2d2d; }
        ::-webkit-scrollbar-thumb { background-color: #565869; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #6e7080; }

        /* MESSAGE STYLING */
        .messages-container { max-width: 768px; margin: 0 auto; }
        .user-message { 
            background-color: #2f2f2f; 
            color: #ececec; 
            border-radius: 18px; 
            padding: 10px 16px; 
            max-width: 85%; 
            margin-left: auto; 
            width: fit-content; 
        }
        .ai-message { color: #ececec; max-width: 100%; line-height: 1.6; }
        .agent-status { color: #8e8ea0; font-size: 0.875rem; margin: 8px 0; }
        
        /* ANIMATIONS */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .user-message-anim { animation: slideInRight 0.3s ease-out forwards; }
        
        .typing-dots span {
            display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #8e8ea0;
            margin: 0 2px; animation: blink 1.4s infinite both;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }

        /* WIDGETS */
        .widget-card { background: linear-gradient(180deg, #262626 0%, #212121 100%); border: 1px solid #3e3e4e; border-radius: 12px; margin: 16px 0; overflow: hidden; transition: all 0.3s ease; position: relative; z-index: 10; }
        .widget-header { padding: 12px 16px; border-bottom: 1px solid #3e3e4e; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: #ececec; }
        .widget-header:hover { background-color: rgba(255, 255, 255, 0.03); }
        .widget-content { transition: height 0.3s ease-out; overflow: hidden; height: auto; }
        
        /* FULLSCREEN MODAL MODE (80% Width + Bevel) */
        .widget-card.maximized {
            position: fixed; 
            top: 5vh; 
            left: 10vw; 
            width: 80vw; 
            height: 90vh;
            z-index: 50; 
            margin: 0;
            background: #212121;
            display: flex; 
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid #52525b; /* Bevel effect */
        }
        .widget-card.maximized .widget-content { flex: 1; overflow: auto; height: auto !important; max-height: none !important; }
        .widget-card.maximized .data-table { max-height: none !important; }

        /* BACKDROP */
        #modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 40; display: none;
        }
        #modal-backdrop.active { display: block; }

        /* KPI GRID */
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .kpi-box { background-color: #1a1a1a; border: 1px solid #3e3e4e; border-radius: 8px; padding: 12px; }
        .kpi-label { font-size: 0.75rem; color: #8e8ea0; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 1.25rem; font-weight: 600; color: #ececec; }

        /* VALIDATION */
        .validation-row { padding: 12px 16px; margin-bottom: 1px; cursor: default; }
        .validation-row.expandable { cursor: pointer; }
        .validation-row:last-child { margin-bottom: 0; }
        
        .val-row-pass { background-color: rgba(16, 185, 129, 0.2); border-left: 3px solid #10b981; }
        .val-row-fail { background-color: rgba(239, 68, 68, 0.2); border-left: 3px solid #ef4444; }

        .val-header { display: flex; justify-content: space-between; align-items: center; }
        .val-pass { color: #10b981; font-weight: 600; } 
        .val-fail { color: #ef4444; font-weight: 600; }
        
        .val-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-left: 8px; }
        .val-details.open { max-height: 300px; margin-top: 8px; overflow-y: auto; }
        .val-error-item { font-size: 0.75rem; color: #d1d5db; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 6px 0; }
        .val-error-item:last-child { border-bottom: none; }
        
        .val-expand-icon { transition: transform 0.2s; margin-left: 8px; }
        .val-expand-icon.rotated { transform: rotate(180deg); }

        /* RISKS */
        .risk-row { display: grid; grid-template-columns: 3fr 1fr 0.8fr 1fr; padding: 12px 0; border-bottom: 1px solid rgba(62, 62, 78, 0.3); color: #ececec; align-items: center; cursor: pointer; transition: background 0.2s; }
        .risk-row:hover { background-color: rgba(255,255,255,0.03); }
        .risk-header { display: grid; grid-template-columns: 3fr 1fr 0.8fr 1fr; padding: 8px 0; border-bottom: 1px solid #3e3e4e; color: #8e8ea0; font-size: 0.75rem; text-transform: uppercase; }
        
        .job-name-bold { font-weight: 700; color: #ffffff; }
        
        .risk-expand-icon { transition: transform 0.2s; margin-left: 6px; color: #666; display: inline-block; vertical-align: middle; }
        .risk-expand-icon.expanded { transform: rotate(180deg); color: #ececec; }
        .risk-details { background-color: rgba(0,0,0,0.2); padding: 0 16px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease; color: #a0a0a0; font-size: 0.875rem; }
        .risk-details.expanded { max-height: 300px; padding: 12px 16px; }
        .risk-level { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; width: fit-content; }
        .risk-high { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .risk-medium { background-color: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .variance-ob { color: #4ade80; } 
        .variance-ub { color: #ef4444; }

        /* WIP SUMMARY */
        .wip-summary { background-color: rgba(0, 191, 255, 0.05); border-left: 3px solid #00BFFF; padding: 16px; border-radius: 6px; margin-bottom: 20px; }
        .wip-summary h4 { color: #00BFFF; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .wip-summary p { color: #d0d0d0; line-height: 1.6; font-size: 0.95rem; }

        /* DATA TABLE */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #2a2a2a; padding: 10px; text-align: left; color: #8e8ea0; font-size: 0.75rem; text-transform: uppercase; position: sticky; top: 0; }
        .data-table td { padding: 10px; border-bottom: 1px solid #333; font-size: 0.85rem; color: #ececec; }
        .text-right { text-align: right; }
        .totals-row td { font-weight: 700; background-color: #2a2a2a; border-top: 2px solid #4b5563; color: #fff; }
        
        .btn-download { background: transparent; color: #00BFFF; font-size: 0.75rem; border: 1px solid #00BFFF; padding: 4px 10px; border-radius: 4px; transition: all 0.2s; margin-right: 8px; }
        .btn-download:hover { background: rgba(0, 191, 255, 0.1); }
        .btn-max { color: #8e8ea0; padding: 4px; border-radius: 4px; transition: all 0.2s; margin-right: 8px; }
        .btn-max:hover { background: rgba(255,255,255,0.1); color: white; }

        /* INPUT UI */
        .input-container { background-color: #2f2f2f; border: 1.5px solid #565869; border-radius: 24px; }
        #chat-input { background: transparent; border: none; outline: none; color: #ececec; padding: 12px 16px; width: 100%; }
        .icon-button { color: #8e8ea0; padding: 8px; border-radius: 50%; }
        .icon-button:hover:not(:disabled) { background-color: rgba(255,255,255,0.1); color: white; }
        
        .welcome-message { text-align: center; color: #00BFFF; margin-bottom: 14px; transition: all 0.3s; }
        .welcome-message.hidden { opacity: 0; height: 0; margin: 0; overflow: hidden; }
        .collapse-icon { transition: transform 0.3s; }
        .collapse-icon.collapsed { transform: rotate(-90deg); }
/* ================================================
   BOND WIDGET STYLES - UPDATED
   ================================================ */

/* Grid for parties/header info */
.bond-grid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 12px; 
    margin-bottom: 20px; 
}

.bond-cell { 
    background: #1a1a1a; 
    padding: 12px; 
    border-radius: 6px; 
    border: 1px solid #3e3e4e; 
}

.bond-label { 
    color: #8e8ea0; 
    font-size: 0.75rem; 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
    margin-bottom: 6px; 
}

.bond-value { 
    color: #ececec; 
    font-weight: 500; 
    font-size: 0.95rem; 
    line-height: 1.4;
}

.bond-value-sm {
    color: #d1d5db;
    font-size: 0.875rem;
    line-height: 1.5;
}

/* Risk clauses list */
.bond-risk-list {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.bond-risk-item {
    padding: 12px 0;
    border-bottom: 1px solid rgba(62, 62, 78, 0.3);
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 16px;
    align-items: start;
}

.bond-risk-item:last-child {
    border-bottom: none;
}

/* Statutes */
.statute-item { 
    border-bottom: 1px solid rgba(62, 62, 78, 0.3); 
    padding: 16px 0; 
}

.statute-item:last-child { 
    border-bottom: none; 
}

.statute-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
    padding: 4px 0;
}

.statute-header:hover {
    background: rgba(255, 255, 255, 0.02);
}

.statute-citation-text { 
    color: #ececec; 
    font-weight: 600; 
    font-size: 0.95rem; 
    margin-bottom: 4px;
}

.statute-name {
    color: #8e8ea0;
    font-size: 0.85rem;
}

.statute-chevron {
    color: #8e8ea0;
    transition: transform 0.3s ease, color 0.2s;
    flex-shrink: 0;
}

.statute-chevron.rotated {
    transform: rotate(180deg);
    color: #ececec;
}

.statute-details-container { 
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding: 0 8px;
}

.statute-details-container.open { 
    max-height: 600px;
    padding: 16px 8px 8px 8px;
}

.statute-section-label {
    color: #8e8ea0;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    font-weight: 600;
}

.statute-text {
    color: #d1d5db;
    font-size: 0.9rem;
    line-height: 1.6;
}

.statute-verbatim { 
    font-family: 'Courier New', monospace; 
    background: #0d0d0d; 
    padding: 12px; 
    border-radius: 4px;
    color: #d1d5db; 
    font-size: 0.85rem; 
    border-left: 3px solid #565869;
    line-height: 1.6;
    white-space: pre-wrap;
}

.statute-link {
    color: #00BFFF;
    font-size: 0.85rem;
    text-decoration: none;
    display: inline-block;
    margin-top: 8px;
    transition: all 0.2s;
}

.statute-link:hover {
    color: #60d9ff;
    text-decoration: underline;
}

/* Opinion Document */
.opinion-badge {
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 4px;
    font-weight: 600;
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.opinion-header-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px;
    padding-bottom: 20px;
    border-bottom: 1px solid #3e3e4e;
}

.opinion-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.opinion-section {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 16px;
    border: 1px solid #3e3e4e;
}

.opinion-subsection {
    padding: 12px 0;
    border-bottom: 1px solid rgba(62, 62, 78, 0.3);
}

.opinion-subsection:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.opinion-label {
    color: #8e8ea0;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    font-weight: 600;
}

.opinion-text {
    color: #ececec;
    font-size: 0.9rem;
    line-height: 1.6;
}
    </style>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globals for use in non-module scripts
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        // --- FIREBASE INIT ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.firebaseApp = app;
            window.db = getFirestore(app);
            window.auth = getAuth(app);

            // Auth Logic
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                    window.userId = window.auth.currentUser.uid;
                    console.log("Authenticated as:", window.userId);
                } catch (error) {
                    console.error("Auth Failed:", error);
                }
            };
            initAuth();
        }

        // Make save function global
        window.saveAnalysis = async (data) => {
            if (!window.db || !window.userId) return;
            try {
                // Path: /artifacts/{appId}/users/{userId}/wip_analyses/{autoId}
                const colRef = collection(window.db, 'artifacts', window.appId, 'users', window.userId, 'wip_analyses');
                await addDoc(colRef, {
                    timestamp: new Date(),
                    data: data
                });
                console.log("Analysis saved to Firestore");
            } catch (e) {
                console.error("Save failed:", e);
            }
        };
    </script>
</head>
<body class="min-h-screen overflow-y-auto pb-32">
    
    <!-- Backdrop for Modal -->
    <div id="modal-backdrop"></div>
    
    <!-- Header -->
    <header class="h-16 flex items-center px-6 sticky top-0 z-30 bg-[#212121]">
        <img src="logo2_bw.png" alt="Wipple" class="h-14" onerror="this.style.display='none'">
    </header>

    <!-- Chat Window -->
    <div id="messages-window" class="messages-container p-6"></div>

    <!-- Input Area -->
    <div class="fixed bottom-0 left-0 right-0 z-30 p-4 bg-[#212121]">
        <div class="max-w-3xl mx-auto">
            <div id="welcome-message" class="welcome-message">
                Welcome to Wipple. Upload your WIP schedule (PDF) to begin analysis.
            </div>
            <div class="input-container flex items-center">
                <input type="file" id="file-input" accept="application/pdf" class="hidden">
                <button id="upload-button" class="icon-button ml-2">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
                <input type="text" id="chat-input" placeholder="Message Wipple" disabled>
                <button id="send-button" class="icon-button mr-2" disabled>
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13L22 2L15 22L11 13L2 9L22 2Z" stroke-linejoin="round" stroke-linecap="round"/></svg>
                </button>
            </div>
        </div>
    </div>

<script>
    // FIXED: HTTPS and correct path
    const API_ENDPOINT = "https://wipple-gemini-production.up.railway.app/analyze-wip-stream";
    
    const messagesWindow = document.getElementById('messages-window');
    const fileInput = document.getElementById('file-input');
    const uploadButton = document.getElementById('upload-button');
    const sendButton = document.getElementById('send-button');
    const chatInput = document.getElementById('chat-input');
    const welcomeMessage = document.getElementById('welcome-message');

    let uploadedFile = null;
    let isProcessing = false;
    let currentLoadingDiv = null;
    let lastTableData = [];
    let lastCalculatedTotals = null;

    const agentStatusMessages = [
        "OCR Agent is scanning the document now...",
        "OCR was successful. Passing to Validation Agent to confirm table validity...",
        "Validations passed. Analyst Agent is preparing final analysis..."
    ];
    let statusStep = 0;

    const fmt = (num) => {
        if(num === undefined || num === null) return '$0';
        if(typeof num === 'string' && (num.includes('M') || num.includes('k') || num.includes('$'))) return num;
        return '$' + Math.round(Number(num)).toLocaleString();
    };

    window.onload = () => { uploadButton.disabled = false; chatInput.disabled = false; };
    uploadButton.addEventListener('click', () => !isProcessing && fileInput.click());
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            uploadedFile = e.target.files[0];
            chatInput.value = `Ready to analyze: ${uploadedFile.name}`;
            sendButton.disabled = false;
        }
    });
    sendButton.addEventListener('click', handleSend);

    function handleSend() {
        if (!uploadedFile || isProcessing) return;
        welcomeMessage.classList.add('hidden');
        isProcessing = true;
        sendButton.disabled = true;
        statusStep = 0;
        
        addMessage(`Uploaded ${uploadedFile.name}`, 'user');
        
        addMessage(agentStatusMessages[0], 'agent-status');
        statusStep = 1;
        
        showLoading();

        const formData = new FormData();
        formData.append('file', uploadedFile);

        fetch(API_ENDPOINT, { method: 'POST', body: formData })
        .then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            function read() {
                reader.read().then(({done, value}) => {
                    if (done) {
                        isProcessing = false;
                        removeLoading();
                        resetUI();
                        return;
                    }
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    lines.forEach(line => {
                        if (line.startsWith('event: status')) {
                            removeLoading();
                            const msg = agentStatusMessages[statusStep];
                            if (msg) {
                                addMessage(msg, 'agent-status');
                                statusStep++;
                            }
                            showLoading();
                        } else if (line.startsWith('event: result')) {
                            removeLoading();
                            const data = JSON.parse(line.split('data: ')[1]);
                            
                            // Render
                            renderResults(data);
                            
                            // SAVE TO FIREBASE
                            if(window.saveAnalysis) {
                                window.saveAnalysis(data);
                            }

                        } else if (line.startsWith('event: error')) {
                            removeLoading();
                            addMessage("Error processing file.", 'error');
                        }
                    });
                    read();
                });
            }
            read();
        });
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = 'mb-4 fade-in';
        
        if (type === 'user') {
            div.innerHTML = `<div class="user-message user-message-anim">${text}</div>`;
        } else if (type === 'agent-status') {
            div.innerHTML = `<div class="agent-status">${text}</div>`;
        } else {
            div.innerHTML = `<div class="ai-message">${text}</div>`;
        }
        messagesWindow.appendChild(div);
        messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }

    function showLoading() {
        if (currentLoadingDiv) return;
        currentLoadingDiv = document.createElement('div');
        currentLoadingDiv.className = 'agent-status mb-4';
        currentLoadingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
        messagesWindow.appendChild(currentLoadingDiv);
        messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }

    function removeLoading() {
        if (currentLoadingDiv) {
            currentLoadingDiv.remove();
            currentLoadingDiv = null;
        }
    }

    function resetUI() {
        fileInput.value = ''; 
        uploadedFile = null;
        chatInput.value = '';
        chatInput.placeholder = "Analysis complete.";
        uploadButton.disabled = false;
        chatInput.disabled = false;
    }

    function renderResults(data) {
        const wd = data.widget_data;
        const m = wd.metrics;
        lastTableData = data.clean_table;
        lastCalculatedTotals = data.calculated_totals;

        // 1. Validation Widget
        const valDiv = document.createElement('div');
        valDiv.innerHTML = renderValidationWidget(wd.validations);
        messagesWindow.appendChild(valDiv);

        // 2. Dashboard Widget
        const dashDiv = document.createElement('div');
        dashDiv.innerHTML = renderDashboardWidget(wd, m);
        messagesWindow.appendChild(dashDiv);

        // 3. Full Table Widget
        const tableDiv = document.createElement('div');
        tableDiv.innerHTML = renderTableWidget(data.clean_table, lastCalculatedTotals);
        messagesWindow.appendChild(tableDiv);
        
        setupCollapsibles();
    }

    function renderValidationWidget(vals) {
        if (!vals) return '';
        
        const genId = () => 'val-' + Math.random().toString(36).substr(2, 9);

        const renderRow = (label, obj) => {
            const hasDetails = obj.details && obj.details.length > 0;
            const rowId = genId();
            const expandableClass = hasDetails ? 'expandable' : '';
            const bgClass = obj.passed ? 'val-row-pass' : 'val-row-fail';
            const statusClass = obj.passed ? 'val-pass' : 'val-fail';
            
            let detailsHtml = '';
            if (hasDetails) {
                const items = obj.details.map(d => `<div class="val-error-item"><span class="font-bold text-white mr-2">${d.id}:</span>${d.msg}</div>`).join('');
                detailsHtml = `<div id="${rowId}-details" class="val-details">${items}</div>`;
            }

            const onClick = hasDetails ? `onclick="toggleValidationDetails('${rowId}')"` : '';
            const icon = hasDetails ? `<svg id="${rowId}-icon" class="val-expand-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>` : '';
            
            const statusIcon = obj.passed ? 
                '<svg class="mr-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>' : 
                '<svg class="mr-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

            return `
                <div class="validation-row ${bgClass} ${expandableClass}" ${onClick}>
                    <div class="val-header">
                        <div class="text-gray-300 text-sm font-medium">${label}</div>
                        <div class="val-status ${statusClass} flex items-center">
                            ${statusIcon}
                            <span>${obj.message}</span>
                            ${icon}
                        </div>
                    </div>
                    ${detailsHtml}
                </div>
            `;
        };

        return `
            <div class="widget-card">
                <div class="widget-header" id="header-val">
                    <span class="font-semibold">Data Integrity Check</span>
                    <svg id="icon-val" class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="widget-content" id="content-val">
                    ${renderRow("Formulaic Validation", vals.formulaic)}
                    ${renderRow("Totals Validation", vals.totals)}
                    ${renderRow("Structural Validation", vals.structural)}
                </div>
            </div>`;
    }
    
    function toggleValidationDetails(rowId) {
        const details = document.getElementById(rowId + '-details');
        const icon = document.getElementById(rowId + '-icon');
        if (!details) return;
        
        details.classList.toggle('open');
        if(icon) icon.classList.toggle('rotated');
        
        const parent = details.closest('.widget-content');
        if(parent && !parent.classList.contains('collapsed')) {
            parent.style.height = 'auto';
        }
    }

    function renderDashboardWidget(data, m) {
        const kpis = `
            <div class="kpi-grid">
                <div class="kpi-box"><div class="kpi-label">${m.row1_1.label}</div><div class="kpi-value">${m.row1_1.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row1_2.label}</div><div class="kpi-value">${m.row1_2.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row1_3.label}</div><div class="kpi-value">${m.row1_3.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row2_1.label}</div><div class="kpi-value">${m.row2_1.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row2_2.label}</div><div class="kpi-value">${m.row2_2.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row2_3.label}</div><div class="kpi-value" style="color:${m.row2_3.value.includes('Over')?'#10b981':'#ef4444'}">${m.row2_3.value}</div></div>
            </div>`;

        let riskRows = '';
        data.riskRowsAll.forEach((r, i) => {
            const riskId = `risk-${i}`;
            riskRows += `
                <div class="risk-row" onclick="toggleRisk('${riskId}')">
                    <div>
                        <div class="font-semibold flex items-center">
                            ${r.jobId}
                            <svg class="risk-expand-icon" id="${riskId}-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <div class="text-xs job-name-bold">${r.jobName || 'No Name'}</div>
                    </div>
                    <div class="text-gray-400 text-xs">${r.riskTags}</div>
                    <div><span class="risk-level ${r.riskLevel === 'high' ? 'risk-high' : 'risk-medium'}">${r.riskLevelLabel}</span></div>
                    <div class="font-semibold text-right ${r.ubobType === 'OB' ? 'variance-ob' : 'variance-ub'}">${r.amountAbs}</div>
                </div>
                <div id="${riskId}" class="risk-details">
                    <div class="py-3">
                        <div class="mb-2 text-gray-300"><strong class="text-white">Analysis:</strong> ${r.analysis}</div>
                        <div class="text-gray-400"><strong>Completion:</strong> ${r.percentComplete}</div>
                    </div>
                </div>`;
        });

        return `
            <div class="widget-card">
                <div class="widget-header" id="header-dash">
                    <span class="font-semibold">WIP Health Summary</span>
                    <svg id="icon-dash" class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="widget-content" id="content-dash">
                    <div class="p-4">
                        <div class="wip-summary"><h4>Portfolio Overview</h4><p>${data.summary.text}</p></div>
                        ${kpis}
                        <div>
                            <h4 class="text-sm font-semibold text-gray-400 mb-3">Top Risks</h4>
                            <div class="risk-table">
                                <div class="risk-header"><div>Job</div><div>Risk Type</div><div>Level</div><div class="text-right"><span class="text-red-400">Under</span> / <span class="text-green-400">Over</span></div></div>
                                ${riskRows}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function renderTableWidget(rows, totals) {
        if(!rows || rows.length === 0) return '';
        let trs = rows.map(r => `
            <tr>
                <td class="font-mono text-xs">${r.job_id}</td>
                <td class="text-gray-400 text-xs" title="${r.job_name}">${r.job_name || '--'}</td>
                <td class="text-right">${fmt(r.total_contract_price)}</td>
                <td class="text-right">${fmt(r.estimated_total_costs)}</td>
                <td class="text-right">${fmt(r.estimated_gross_profit)}</td>
                <td class="text-right">${fmt(r.billed_to_date)}</td>
                <td class="text-right">${fmt(r.cost_to_date)}</td>
                <td class="text-right text-red-400">${r.under_billings > 0 ? fmt(r.under_billings) : '-'}</td>
                <td class="text-right text-green-400">${r.over_billings > 0 ? fmt(r.over_billings) : '-'}</td>
                <td class="text-right">${fmt(r.uegp)}</td>
                <td class="text-right">${fmt(r.cost_to_complete)}</td>
            </tr>`).join('');

        // Append Totals Row
        if (totals) {
            trs += `
            <tr class="totals-row">
                <td>TOTAL</td>
                <td></td>
                <td class="text-right">${fmt(totals.total_contract_price)}</td>
                <td class="text-right">${fmt(totals.estimated_total_costs)}</td>
                <td class="text-right">${fmt(totals.estimated_gross_profit)}</td>
                <td class="text-right">${fmt(totals.billed_to_date)}</td>
                <td class="text-right">${fmt(totals.cost_to_date)}</td>
                <td class="text-right text-red-400">${fmt(totals.under_billings)}</td>
                <td class="text-right text-green-400">${fmt(totals.over_billings)}</td>
                <td class="text-right">${fmt(totals.uegp)}</td>
                <td class="text-right">${fmt(totals.cost_to_complete)}</td>
            </tr>`;
        }

        const tableId = 'tbl-' + Math.random().toString(36).substr(2, 9);

        return `
             <div class="widget-card" id="card-${tableId}">
                <div class="widget-header" id="header-${tableId}" style="padding-right: 8px;">
                    <span class="font-semibold flex-1">Validated WIP (${rows.length} Rows)</span>
                    <button onclick="toggleMaximize('${tableId}', event)" class="btn-max" title="Maximize">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                    </button>
                    <button onclick="downloadCSV(event)" class="btn-download">Download CSV</button>
                    <svg id="icon-${tableId}" class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="widget-content collapsed" id="content-${tableId}" style="height: 0px;">
                    <div class="data-table" style="max-height: 400px; overflow-y: auto;">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>ID</th><th>Name</th><th class="text-right">Contract</th>
                                    <th class="text-right">Est Cost</th><th class="text-right">Est GP</th>
                                    <th class="text-right">Billed</th><th class="text-right">Costs</th>
                                    <th class="text-right">UB</th><th class="text-right">OB</th>
                                    <th class="text-right">UEGP</th><th class="text-right">CTC</th>
                                </tr>
                            </thead>
                            <tbody>${trs}</tbody>
                        </table>
                    </div>
                </div>
            </div>`;
    }

    function toggleMaximize(id, e) {
        e.stopPropagation();
        const card = document.getElementById(`card-${id}`);
        const backdrop = document.getElementById('modal-backdrop');
        
        if(card.classList.contains('maximized')) {
            card.classList.remove('maximized');
            backdrop.classList.remove('active');
        } else {
            card.classList.add('maximized');
            backdrop.classList.add('active');
            const content = document.getElementById(`content-${id}`);
            content.classList.remove('collapsed');
            content.style.height = 'auto';
        }
    }

    function downloadCSV(e) {
        e.stopPropagation(); 
        if (!lastTableData || !lastTableData.length) return;
        
        const headers = [
            "job_id", "job_name", "total_contract_price", "estimated_total_costs", "estimated_gross_profit",
            "billed_to_date", "cost_to_date", "under_billings", "over_billings", "uegp", "cost_to_complete"
        ];
        
        const csvRows = [headers.join(',')];
        
        // Rows
        for (const row of lastTableData) {
            const values = headers.map(header => {
                const val = row[header];
                return `"${('' + val).replace(/"/g, '""')}"`;
            });
            csvRows.push(values.join(','));
        }
        
        // TOTALS ROW
        if (lastCalculatedTotals) {
            const totalValues = headers.map(header => {
                if (header === 'job_id') return '"TOTALS"';
                if (header === 'job_name') return '""';
                const val = lastCalculatedTotals[header] || 0;
                return `"${val}"`;
            });
            csvRows.push(totalValues.join(','));
        }
        
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'wip_extract.csv'; a.click();
    }

    function toggleRisk(id) {
        const el = document.getElementById(id);
        const icon = document.getElementById(id + '-icon');
        el.classList.toggle('expanded');
        if(icon) icon.classList.toggle('expanded');
    }

    function setupCollapsibles() {
        const widgets = document.querySelectorAll('.widget-card');
        widgets.forEach(widget => {
            const header = widget.querySelector('.widget-header');
            const content = widget.querySelector('.widget-content');
            const icon = widget.querySelector('.collapse-icon');
            
            if(!header || !content) return;
            
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            
            newHeader.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    content.style.height = content.scrollHeight + "px";
                    if(icon) icon.classList.remove('collapsed');
                    setTimeout(() => { if(!content.classList.contains('collapsed')) content.style.height = 'auto'; }, 300);
                } else {
                    content.style.height = content.scrollHeight + "px";
                    content.offsetHeight; 
                    content.classList.add('collapsed');
                    content.style.height = "0px";
                    if(icon) icon.classList.add('collapsed');
                }
            });
        });
    }

// ========================================
// BOND WIDGET RENDERERS - UPDATED
// ========================================

function renderBondWidget1(data) {
    const p = data.parties;
    const r = data.risks;
    
    const html = `
    <div class="widget-card">
        <div class="widget-header">
            <span class="font-semibold">Bond Analysis & Risk Terms</span>
            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="widget-content" style="padding: 20px;">
            
            <!-- Parties Section -->
            <div style="margin-bottom: 24px;">
                <h4 style="color: #8e8ea0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Parties Involved</h4>
                <div class="bond-grid">
                    <div class="bond-cell">
                        <div class="bond-label">Principal</div>
                        <div class="bond-value">${p.principal_name}</div>
                    </div>
                    <div class="bond-cell">
                        <div class="bond-label">Obligee</div>
                        <div class="bond-value">${p.obligee_name}</div>
                    </div>
                    <div class="bond-cell">
                        <div class="bond-label">Surety</div>
                        <div class="bond-value">${p.surety_name || 'Not Specified'}</div>
                    </div>
                    <div class="bond-cell">
                        <div class="bond-label">Penal Sum</div>
                        <div class="bond-value" style="color: #10b981; font-weight: 600;">${p.penal_sum}</div>
                    </div>
                </div>
            </div>

            <!-- Key Risk Clauses Section -->
            <div>
                <h4 style="color: #8e8ea0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Key Risk Clauses</h4>
                <div class="bond-risk-list">
                    <div class="bond-risk-item">
                        <div class="bond-label">Security Required</div>
                        <div class="bond-value-sm">${r.security_required}</div>
                    </div>
                    <div class="bond-risk-item">
                        <div class="bond-label">Type</div>
                        <div class="bond-value-sm">${r.bond_type}</div>
                    </div>
                    <div class="bond-risk-item">
                        <div class="bond-label">Forms Provided</div>
                        <div class="bond-value-sm">${r.forms_provided}</div>
                    </div>
                    <div class="bond-risk-item">
                        <div class="bond-label">Adjustable Amount</div>
                        <div class="bond-value-sm">${r.adjustable_amount}</div>
                    </div>
                    <div class="bond-risk-item">
                        <div class="bond-label">Cancellation Notice Period</div>
                        <div class="bond-value-sm">${r.cancellation_notice_period}</div>
                    </div>
                    <div class="bond-risk-item">
                        <div class="bond-label">Effective Duration</div>
                        <div class="bond-value-sm">${r.effective_duration}</div>
                    </div>
                    <div class="bond-risk-item">
                        <div class="bond-label">Quick Payment Terms</div>
                        <div class="bond-value-sm">${r.quick_payment_terms}</div>
                    </div>
                    <div class="bond-risk-item">
                        <div class="bond-label">Efficiency Guarantees</div>
                        <div class="bond-value-sm">${r.efficiency_guarantees}</div>
                    </div>
                    <div class="bond-risk-item">
                        <div class="bond-label">Enforcement Mechanisms</div>
                        <div class="bond-value-sm">${r.enforcement_mechanisms}</div>
                    </div>
                    <div class="bond-risk-item" style="border: none;">
                        <div class="bond-label">Cancellation Terms</div>
                        <div class="bond-value-sm" style="font-style: italic; color: #d1d5db;">"${r.cancellation_terms}"</div>
                    </div>
                    <div class="bond-risk-item" style="border: none;">
                        <div class="bond-label">Forfeiture Language</div>
                        <div class="bond-value-sm" style="font-style: italic; color: #d1d5db;">${r.forfeiture_language}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
    
    addMessage(html, 'widget');
    setupCollapsibles();
}

function renderBondWidget2(statutes) {
    if (!statutes || statutes.length === 0) {
        const html = `
        <div class="widget-card">
            <div class="widget-header">
                <span class="font-semibold">Statutory References & Compliance</span>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="widget-content" style="padding: 20px;">
                <div style="color: #8e8ea0; font-size: 0.875rem;">No specific statutes cited in this bond.</div>
            </div>
        </div>`;
        addMessage(html, 'widget');
        setupCollapsibles();
        return;
    }

    const items = statutes.map((s, idx) => {
        const hasExcerpt = s.verbatim_text && s.verbatim_text !== 'Excerpt not found.';
        const hasSummary = s.plain_summary && s.plain_summary.length > 0;
        
        return `
            <div class="statute-item">
                <div class="statute-header" onclick="toggleStatute(${idx})">
                    <div>
                        <div class="statute-citation-text">${s.citation}</div>
                        <div class="statute-name">${s.name}</div>
                    </div>
                    <svg id="statute-icon-${idx}" class="statute-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div id="stat-${idx}" class="statute-details-container">
                    ${hasSummary ? `
                        <div style="margin-bottom: 12px;">
                            <div class="statute-section-label">SUMMARY</div>
                            <div class="statute-text">${s.plain_summary}</div>
                        </div>
                    ` : ''}
                    ${hasExcerpt ? `
                        <div style="margin-bottom: 12px;">
                            <div class="statute-section-label">VERBATIM TEXT</div>
                            <div class="statute-verbatim">${s.verbatim_text}</div>
                        </div>
                    ` : ''}
                    ${s.source_link ? `
                        <a href="${s.source_link}" target="_blank" class="statute-link">
                            View Official Source â†—
                        </a>
                    ` : ''}
                    ${!hasExcerpt && !hasSummary ? `
                        <div class="statute-text" style="color: #8e8ea0;">Statute identified but unable to retrieve official excerpt.</div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');

    const html = `
    <div class="widget-card">
        <div class="widget-header">
            <span class="font-semibold">Statutory References & Compliance</span>
            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="widget-content" style="padding: 20px;">
            ${items}
        </div>
    </div>`;
    
    addMessage(html, 'widget');
    setupCollapsibles();
}

window.toggleStatute = (idx) => {
    const el = document.getElementById(`stat-${idx}`);
    const icon = document.getElementById(`statute-icon-${idx}`);
    
    if (!el) return;
    
    if (el.classList.contains('open')) {
        el.classList.remove('open');
        if (icon) icon.classList.remove('rotated');
    } else {
        el.classList.add('open');
        if (icon) icon.classList.add('rotated');
    }
};

function renderBondWidget3(op) {
    const html = `
    <div class="widget-card">
        <div class="widget-header">
            <div class="flex items-center space-x-2">
                <span class="font-semibold">Underwriting Opinion</span>
                <span class="opinion-badge">${op.recommendation}</span>
            </div>
            <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </div>
        <div class="widget-content" style="padding: 20px;">
            
            <!-- Header Info Grid -->
            <div class="opinion-header-grid">
                <div class="opinion-field">
                    <div class="bond-label">Risk State</div>
                    <div class="bond-value">${op.risk_state}</div>
                </div>
                <div class="opinion-field">
                    <div class="bond-label">Obligee</div>
                    <div class="bond-value">${op.obligee}</div>
                </div>
                <div class="opinion-field">
                    <div class="bond-label">Bond Description</div>
                    <div class="bond-value">${op.bond_description}</div>
                </div>
                <div class="opinion-field">
                    <div class="bond-label">SFAA No. / Descriptor</div>
                    <div class="bond-value">${op.sfaa_descriptor}</div>
                </div>
                <div class="opinion-field">
                    <div class="bond-label">Penalty</div>
                    <div class="bond-value" style="color: #10b981; font-weight: 600;">${op.penalty}</div>
                </div>
                <div class="opinion-field" style="grid-column: span 1;">
                    <div class="bond-label">Statutory References</div>
                    <div class="bond-value-sm">${op.statutory_references.join(', ')}</div>
                </div>
            </div>

            <!-- Legal Opinion Section -->
            <div style="margin-top: 24px;">
                <h4 style="color: #00BFFF; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; margin-bottom: 16px; letter-spacing: 0.5px;">Legal Opinion</h4>
                
                <div class="opinion-section">
                    <div class="opinion-subsection">
                        <div class="opinion-label">Who Must Post Bond</div>
                        <div class="opinion-text">${op.who_must_post}</div>
                    </div>
                    
                    <div class="opinion-subsection">
                        <div class="opinion-label">Statutory Definitions</div>
                        <div class="opinion-text">${op.statutory_definitions}</div>
                    </div>
                    
                    <div class="opinion-subsection">
                        <div class="opinion-label">Exemptions</div>
                        <div class="opinion-text">${op.exemptions}</div>
                    </div>
                    
                    <div class="opinion-subsection">
                        <div class="opinion-label">Bond Guarantees</div>
                        <div class="opinion-text">${op.bond_guarantees}</div>
                    </div>
                    
                    <div class="opinion-subsection">
                        <div class="opinion-label">Licensing/Bonding Deadlines</div>
                        <div class="opinion-text">${op.deadlines_cycles}</div>
                    </div>
                    
                    <div class="opinion-subsection">
                        <div class="opinion-label">Past Claims Experience</div>
                        <div class="opinion-text">${op.claims_history}</div>
                    </div>
                    
                    <div class="opinion-subsection">
                        <div class="opinion-label">Alternative Instruments</div>
                        <div class="opinion-text">${op.alternative_instruments}</div>
                    </div>
                </div>
            </div>

            <!-- Cancellation Section -->
            <div style="margin-top: 24px;">
                <h4 style="color: #00BFFF; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px;">Cancellation Clause</h4>
                
                <div style="background: #1a1a1a; padding: 14px; border-radius: 6px; border-left: 3px solid #3e3e4e; margin-bottom: 12px;">
                    <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #d1d5db; font-style: italic; line-height: 1.6;">
                        "${op.cancellation_verbatim}"
                    </div>
                </div>
                
                <div style="background: rgba(0, 191, 255, 0.05); padding: 12px; border-radius: 6px; border-left: 3px solid #00BFFF;">
                    <div style="color: #8e8ea0; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px;">Summary</div>
                    <div style="color: #ececec; font-size: 0.9rem; line-height: 1.5;">${op.cancellation_summary}</div>
                </div>
            </div>

        </div>
    </div>`;
    
    addMessage(html, 'widget');
    setupCollapsibles();
}

</script>
</body>
</html>
