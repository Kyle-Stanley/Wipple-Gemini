<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wipple</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* BASE & LAYOUT */
        body { font-family: 'Inter', sans-serif; background-color: #212121; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #2d2d2d; }
        ::-webkit-scrollbar-thumb { background-color: #565869; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #6e7080; }

        /* MESSAGE STYLING */
        .messages-container { max-width: 768px; margin: 0 auto; }
        .user-message { 
            background-color: #2f2f2f; 
            color: #ececec; 
            border-radius: 18px; 
            padding: 10px 16px; 
            max-width: 85%; 
            margin-left: auto; 
            width: fit-content; 
        }
        .ai-message { color: #ececec; max-width: 100%; line-height: 1.6; }
        .agent-status { color: #8e8ea0; font-size: 0.875rem; margin: 8px 0; }
        
        /* ANIMATIONS */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .user-message-anim { animation: slideInRight 0.3s ease-out forwards; }
        
        .typing-dots span {
            display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #8e8ea0;
            margin: 0 2px; animation: blink 1.4s infinite both;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }

        /* WIDGETS */
        .widget-card { background: linear-gradient(180deg, #262626 0%, #212121 100%); border: 1px solid #3e3e4e; border-radius: 12px; margin: 16px 0; overflow: hidden; transition: all 0.3s ease; position: relative; z-index: 10; }
        .widget-header { padding: 12px 16px; border-bottom: 1px solid #3e3e4e; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: #ececec; }
        .widget-header:hover { background-color: rgba(255, 255, 255, 0.03); }
        .widget-content { transition: height 0.3s ease-out; overflow: hidden; height: auto; }
        
        /* FULLSCREEN MODAL MODE (80% Width + Bevel) */
        .widget-card.maximized {
            position: fixed; 
            top: 5vh; 
            left: 10vw; 
            width: 80vw; 
            height: 90vh;
            z-index: 50; 
            margin: 0;
            background: #212121;
            display: flex; 
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid #52525b;
        }
        .widget-card.maximized .widget-content { flex: 1; overflow: auto; height: auto !important; max-height: none !important; }
        .widget-card.maximized .data-table { max-height: none !important; }

        /* BACKDROP */
        #modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 40; display: none;
        }
        #modal-backdrop.active { display: block; }

        /* KPI GRID */
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .kpi-box { background-color: #1a1a1a; border: 1px solid #3e3e4e; border-radius: 8px; padding: 12px; }
        .kpi-label { font-size: 0.75rem; color: #8e8ea0; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 1.25rem; font-weight: 600; color: #ececec; }

        /* VALIDATION - Updated for job-grouped display */
        .validation-section { margin-bottom: 1px; }
        .validation-row { padding: 12px 16px; margin-bottom: 1px; cursor: default; }
        .validation-row.expandable { cursor: pointer; }
        .validation-row:last-child { margin-bottom: 0; }
        
        .val-row-pass { background-color: rgba(16, 185, 129, 0.2); border-left: 3px solid #10b981; }
        .val-row-fail { background-color: rgba(239, 68, 68, 0.2); border-left: 3px solid #ef4444; }

        .val-header { display: flex; justify-content: space-between; align-items: center; }
        .val-pass { color: #10b981; font-weight: 600; } 
        .val-fail { color: #ef4444; font-weight: 600; }
        
        .val-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding-left: 8px; }
        .val-details.open { max-height: 500px; margin-top: 8px; overflow-y: auto; }
        
        .val-expand-icon { transition: transform 0.2s; margin-left: 8px; }
        .val-expand-icon.rotated { transform: rotate(180deg); }

        /* Job issue item styling - FLAT layout */
        .job-issue-flat { 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding: 12px 0; 
        }
        .job-issue-flat:last-child { border-bottom: none; }
        .job-issue-header-flat { 
            display: flex; 
            align-items: center; 
            padding: 4px 0;
            margin-bottom: 8px;
        }
        .job-issue-id { 
            font-weight: 700; 
            color: #ffffff; 
            font-size: 0.9rem;
            min-width: 90px;
        }
        .job-issue-summary { 
            color: #9ca3af; 
            font-size: 0.8rem; 
            flex: 1;
        }
        .job-issue-content {
            padding-left: 0;
        }
        .error-line { 
            color: #f87171; 
            font-size: 0.8rem; 
            padding: 4px 0;
            padding-left: 12px;
        }
        .correction-line { 
            color: #38bdf8; 
            font-size: 0.8rem; 
            padding: 8px 12px;
            border-left: 2px solid #38bdf8;
            margin: 8px 0;
            background: rgba(56, 189, 248, 0.05);
        }
        .correction-arrow {
            font-weight: 600;
            margin-right: 6px;
        }
        .correction-text {
            display: inline;
        }
        .correction-reasoning {
            margin-top: 6px; 
            color: #8e8ea0; 
            font-size: 0.75rem;
            line-height: 1.4;
        }
        .confidence-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            text-transform: uppercase;
        }
        .confidence-high { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .confidence-medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .confidence-low { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }

        /* RISKS - Updated layout */
        .risk-row { 
            display: grid; 
            grid-template-columns: 160px 1fr 80px; 
            gap: 16px;
            padding: 12px 0; 
            border-bottom: 1px solid rgba(62, 62, 78, 0.3); 
            color: #ececec; 
            align-items: center; 
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .risk-row:hover { background-color: rgba(255,255,255,0.03); }
        .risk-header { 
            display: grid; 
            grid-template-columns: 160px 1fr 80px; 
            gap: 16px;
            padding: 8px 0; 
            border-bottom: 1px solid #3e3e4e; 
            color: #8e8ea0; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
        }
        
        .job-name-bold { font-weight: 700; color: #ffffff; }
        
        .risk-expand-icon { transition: transform 0.2s; margin-left: 6px; color: #666; display: inline-block; vertical-align: middle; }
        .risk-expand-icon.expanded { transform: rotate(180deg); color: #ececec; }
        
        .risk-details { 
            background-color: rgba(0,0,0,0.2); 
            padding: 0 16px; 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease-out, padding 0.3s ease; 
            color: #a0a0a0; 
            font-size: 0.875rem; 
        }
        .risk-details.expanded { max-height: 500px; padding: 16px; }
        
        .risk-detail-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .risk-detail-item:last-child { border-bottom: none; }
        .risk-detail-tag {
            font-weight: 600;
            color: #ececec;
            margin-bottom: 4px;
        }
        .risk-detail-summary {
            color: #d1d5db;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .risk-detail-explanation {
            color: #8e8ea0;
            font-size: 0.8rem;
            font-style: italic;
        }
        
        /* Risk tier badges */
        .risk-tier { 
            padding: 4px 10px; 
            border-radius: 4px; 
            font-size: 0.7rem; 
            font-weight: 700; 
            width: fit-content;
            letter-spacing: 0.5px;
        }
        .risk-tier-high { background-color: rgba(239, 68, 68, 0.25); color: #ef4444; }
        .risk-tier-medium { background-color: rgba(251, 191, 36, 0.25); color: #fbbf24; }
        .risk-tier-low { background-color: rgba(16, 185, 129, 0.25); color: #10b981; }

        /* Portfolio risk tier in header */
        .portfolio-tier-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-left: 12px;
        }
        .portfolio-tier-high { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .portfolio-tier-moderate { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
        .portfolio-tier-low { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }

        /* WIP SUMMARY */
        .wip-summary { background-color: rgba(0, 191, 255, 0.05); border-left: 3px solid #00BFFF; padding: 16px; border-radius: 6px; margin-bottom: 20px; }
        .wip-summary h4 { color: #00BFFF; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .wip-summary p { color: #d0d0d0; line-height: 1.6; font-size: 0.95rem; }

        /* DATA TABLE */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #2a2a2a; padding: 10px; text-align: left; color: #8e8ea0; font-size: 0.75rem; text-transform: uppercase; position: sticky; top: 0; }
        .data-table td { padding: 10px; border-bottom: 1px solid #333; font-size: 0.85rem; color: #ececec; }
        .text-right { text-align: right; }
        .totals-row td { font-weight: 700; background-color: #2a2a2a; border-top: 2px solid #4b5563; color: #fff; }
        
        .btn-download { background: transparent; color: #00BFFF; font-size: 0.75rem; border: 1px solid #00BFFF; padding: 4px 10px; border-radius: 4px; transition: all 0.2s; margin-right: 8px; }
        .btn-download:hover { background: rgba(0, 191, 255, 0.1); }
        .btn-max { color: #8e8ea0; padding: 4px; border-radius: 4px; transition: all 0.2s; margin-right: 8px; }
        .btn-max:hover { background: rgba(255,255,255,0.1); color: white; }

        /* INPUT UI */
        .input-container { background-color: #2f2f2f; border: 1.5px solid #565869; border-radius: 24px; }
        #chat-input { background: transparent; border: none; outline: none; color: #ececec; padding: 12px 16px; width: 100%; }
        .icon-button { color: #8e8ea0; padding: 8px; border-radius: 50%; }
        .icon-button:hover:not(:disabled) { background-color: rgba(255,255,255,0.1); color: white; }
        
        .collapse-icon { transition: transform 0.3s; }
        .collapse-icon.collapsed { transform: rotate(-90deg); }

        /* === BOND WIDGET STYLES === */
        .bond-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .bond-cell { background: #1a1a1a; padding: 12px; border-radius: 6px; border: 1px solid #3e3e4e; }
        .bond-label { color: #8e8ea0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .bond-value { color: #ececec; font-weight: 500; font-size: 0.95rem; line-height: 1.4; }
        .bond-value-sm { color: #d1d5db; font-size: 0.875rem; line-height: 1.5; }
        .bond-risk-list { display: flex; flex-direction: column; gap: 0; }
        .bond-risk-item { padding: 12px 0; border-bottom: 1px solid rgba(62, 62, 78, 0.3); display: grid; grid-template-columns: 200px 1fr; gap: 16px; align-items: start; }
        .bond-risk-item:last-child { border-bottom: none; }
        
        .statute-item { border-bottom: 1px solid rgba(62, 62, 78, 0.3); padding: 16px 0; }
        .statute-item:last-child { border-bottom: none; }
        .statute-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; padding: 4px 0; }
        .statute-header:hover { background: rgba(255, 255, 255, 0.02); }
        .statute-citation-text { color: #ececec; font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
        .statute-name { color: #8e8ea0; font-size: 0.85rem; }
        .statute-chevron { color: #8e8ea0; transition: transform 0.3s ease, color 0.2s; flex-shrink: 0; }
        .statute-chevron.rotated { transform: rotate(180deg); color: #ececec; }
        .statute-details-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 8px; }
        .statute-details-container.open { max-height: 600px; padding: 16px 8px 8px 8px; }
        .statute-section-label { color: #8e8ea0; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600; }
        .statute-text { color: #d1d5db; font-size: 0.9rem; line-height: 1.6; }
        .statute-verbatim { font-family: 'Courier New', monospace; background: #0d0d0d; padding: 12px; border-radius: 4px; color: #d1d5db; font-size: 0.85rem; border-left: 3px solid #565869; line-height: 1.6; white-space: pre-wrap; }
        .statute-link { color: #00BFFF; font-size: 0.85rem; text-decoration: none; display: inline-block; margin-top: 8px; transition: all 0.2s; }
        .statute-link:hover { color: #60d9ff; text-decoration: underline; }
        
        .opinion-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 4px; font-weight: 600; background: rgba(16, 185, 129, 0.15); color: #10b981; text-transform: uppercase; letter-spacing: 0.5px; }
        .opinion-header-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; padding-bottom: 20px; border-bottom: 1px solid #3e3e4e; }
        .opinion-field { display: flex; flex-direction: column; gap: 6px; }
        .opinion-section { background: #1a1a1a; border-radius: 8px; padding: 16px; border: 1px solid #3e3e4e; }
        .opinion-subsection { padding: 12px 0; border-bottom: 1px solid rgba(62, 62, 78, 0.3); }
        .opinion-subsection:last-child { border-bottom: none; padding-bottom: 0; }
        .opinion-label { color: #8e8ea0; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600; }
        .opinion-text { color: #ececec; font-size: 0.9rem; line-height: 1.6; }

        /* MODEL SELECTOR */
        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 12px;
        }
        .model-selector label {
            color: #8e8ea0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .model-selector select {
            background-color: #1a1a1a;
            border: 1px solid #3e3e4e;
            border-radius: 6px;
            color: #ececec;
            padding: 6px 28px 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238e8ea0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            transition: all 0.2s;
        }
        .model-selector select:hover {
            border-color: #565869;
        }
        .model-selector select:focus {
            border-color: #00BFFF;
        }

        /* METRICS WIDGET */
        .metrics-widget {
            background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%);
            border: 1px solid #3e3e4e;
            border-radius: 10px;
            padding: 14px 18px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        .metrics-widget-title {
            color: #8e8ea0;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .metrics-model-name {
            color: #00BFFF;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .metrics-stats {
            display: flex;
            gap: 24px;
        }
        .metrics-stat {
            text-align: center;
        }
        .metrics-stat-value {
            color: #ececec;
            font-size: 1rem;
            font-weight: 600;
        }
        .metrics-stat-label {
            color: #8e8ea0;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 2px;
        }
        .metrics-cost {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            padding: 8px 14px;
            text-align: center;
        }
        .metrics-cost-value {
            color: #10b981;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .metrics-cost-label {
            color: #10b981;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            opacity: 0.8;
        }

        /* COMPARE MODE */
        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            margin-bottom: 8px;
        }

        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .mode-toggle-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #3e3e4e;
            background: transparent;
            color: #8e8ea0;
        }
        .mode-toggle-btn.active {
            background: rgba(0, 191, 255, 0.15);
            border-color: #00BFFF;
            color: #00BFFF;
        }
        .mode-toggle-btn:hover:not(.active) {
            border-color: #565869;
            color: #ececec;
        }

        .model-selectors {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .model-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .model-group label {
            color: #8e8ea0;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .model-group select {
            background-color: #1a1a1a;
            border: 1px solid #3e3e4e;
            border-radius: 6px;
            color: #ececec;
            padding: 6px 28px 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238e8ea0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            transition: all 0.2s;
        }
        .model-group select:hover {
            border-color: #565869;
        }

        /* Model B - hidden by default, slides in */
        .model-group-b {
            overflow: hidden;
            max-width: 0;
            opacity: 0;
            transition: max-width 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            margin-left: 0;
            white-space: nowrap;
        }
        body.compare-mode .model-group-b {
            max-width: 250px;
            opacity: 1;
            margin-left: 16px;
        }

        /* View fade transitions */
        .messages-container {
            animation: fadeIn 0.25s ease;
        }
        #compare-view {
            animation: fadeIn 0.25s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Compare layout */
        .compare-container {
            display: grid;
            grid-template-columns: 1fr 1px 1fr;
            gap: 0;
            max-width: 1800px;
            margin: 0 auto;
            padding: 0;
            min-height: calc(100vh - 200px);
        }
        .compare-divider {
            background: #3e3e4e;
            width: 1px;
        }
        .compare-panel {
            display: flex;
            flex-direction: column;
            min-height: 400px;
            overflow: hidden;
        }
        .compare-panel-header {
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e4e;
            background: #212121;
            flex-shrink: 0;
        }
        .compare-panel-title {
            font-weight: 600;
            color: #8e8ea0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .compare-panel-model {
            color: #ececec;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .compare-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        .compare-panel-content .widget-card {
            margin: 12px 0;
        }
        .compare-panel-content .agent-status {
            margin: 8px 0;
        }

        /* Hide/show based on mode */
        body.compare-mode .messages-container { display: none; }
        body.compare-mode #compare-view { display: grid; }
        #compare-view { display: none; }
    </style>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.firebaseApp = app;
            window.db = getFirestore(app);
            window.auth = getAuth(app);

            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                    window.userId = window.auth.currentUser.uid;
                    console.log("Authenticated as:", window.userId);
                } catch (error) {
                    console.error("Auth Failed:", error);
                }
            };
            initAuth();
        }

        window.saveAnalysis = async (data) => {
            if (!window.db || !window.userId) return;
            try {
                const colRef = collection(window.db, 'artifacts', window.appId, 'users', window.userId, 'wip_analyses');
                await addDoc(colRef, {
                    timestamp: new Date(),
                    data: data
                });
                console.log("Analysis saved to Firestore");
            } catch (e) {
                console.error("Save failed:", e);
            }
        };
    </script>
</head>
<body class="min-h-screen overflow-y-auto pb-32">
    
    <!-- Backdrop for Modal -->
    <div id="modal-backdrop"></div>
    
    <!-- Header -->
    <header class="h-16 flex items-center px-6 sticky top-0 z-30 bg-[#212121]" style="padding-top: 12px;">
        <img src="logo2_bw.png" alt="Wipple" class="h-14" onerror="this.style.display='none'">
    </header>

    <!-- Chat Window -->
    <div id="messages-window" class="messages-container p-6"></div>

    <!-- Compare View (hidden by default) -->
    <div id="compare-view" class="compare-container">
        <div class="compare-panel panel-a">
            <div class="compare-panel-header">
                <span class="compare-panel-title">Model A</span>
                <span class="compare-panel-model" id="compare-model-a-name">-</span>
            </div>
            <div class="compare-panel-content" id="compare-panel-a"></div>
        </div>
        <div class="compare-divider"></div>
        <div class="compare-panel panel-b">
            <div class="compare-panel-header">
                <span class="compare-panel-title">Model B</span>
                <span class="compare-panel-model" id="compare-model-b-name">-</span>
            </div>
            <div class="compare-panel-content" id="compare-panel-b"></div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="fixed bottom-0 left-0 right-0 z-30 p-4 bg-[#212121]">
        <div class="max-w-3xl mx-auto">
            <!-- Unified Controls Row -->
            <div class="controls-row">
                <div class="mode-toggle">
                    <button id="mode-single" class="mode-toggle-btn active">Single</button>
                    <button id="mode-compare" class="mode-toggle-btn">Compare</button>
                </div>
                <div class="model-selectors">
                    <div class="model-group">
                        <label id="model-a-label">Model</label>
                        <select id="model-select-a">
                            <option value="gemini-3-pro">Gemini 3 Pro</option>
                            <option value="claude-sonnet-4-5">Claude Sonnet 4.5</option>
                            <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
                            <option value="claude-opus-4-5">Claude Opus 4.5</option>
                        </select>
                    </div>
                    <div class="model-group model-group-b">
                        <label>Model B</label>
                        <select id="model-select-b">
                            <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5</option>
                            <option value="gemini-3-pro">Gemini 3 Pro</option>
                            <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
                            <option value="claude-opus-4-5">Claude Opus 4.5</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="input-container flex items-center">
                <input type="file" id="file-input" accept="application/pdf" class="hidden">
                <button id="upload-button" class="icon-button ml-2">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
                <input type="text" id="chat-input" placeholder="Message Wipple" disabled>
                <button id="send-button" class="icon-button mr-2" disabled>
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13L22 2L15 22L11 13L2 9L22 2Z" stroke-linejoin="round" stroke-linecap="round"/></svg>
                </button>
            </div>
        </div>
    </div>

<script>
    const API_ENDPOINT = "https://api.wipple.ai/analyze-stream";
    const CHAT_ENDPOINT = "https://api.wipple.ai/chat";
        
    const messagesWindow = document.getElementById('messages-window');
    const fileInput = document.getElementById('file-input');
    const uploadButton = document.getElementById('upload-button');
    const sendButton = document.getElementById('send-button');
    const chatInput = document.getElementById('chat-input');
    const modelSelectA = document.getElementById('model-select-a');
    const modelSelectB = document.getElementById('model-select-b');
    const modelALabel = document.getElementById('model-a-label');
    const modeSingleBtn = document.getElementById('mode-single');
    const modeCompareBtn = document.getElementById('mode-compare');
    const comparePanelA = document.getElementById('compare-panel-a');
    const comparePanelB = document.getElementById('compare-panel-b');
    const compareModelAName = document.getElementById('compare-model-a-name');
    const compareModelBName = document.getElementById('compare-model-b-name');

    let uploadedFile = null;
    let isProcessing = false;
    let currentLoadingDiv = null;
    let lastTableData = [];
    let lastCalculatedTotals = null;
    let fullAnalysisContext = null;
    let selectedModel = 'gemini-3-pro';
    let compareMode = false;

    function setCompareMode(enabled) {
        if (isProcessing) return;
        compareMode = enabled;
        if (enabled) {
            document.body.classList.add('compare-mode');
            modeCompareBtn.classList.add('active');
            modeSingleBtn.classList.remove('active');
            modelALabel.textContent = 'Model A';
        } else {
            document.body.classList.remove('compare-mode');
            modeSingleBtn.classList.add('active');
            modeCompareBtn.classList.remove('active');
            modelALabel.textContent = 'Model';
        }
    }

    const agentStatusMessages = [
        "OCR Agent is scanning the document now...",
        "OCR was successful. Passing to Validation Agent to confirm table validity...",
        "Validations passed. Analyst Agent is preparing final analysis..."
    ];
    let statusStep = 0;

    const fmt = (num) => {
        if(num === undefined || num === null) return '$0';
        if(typeof num === 'string' && (num.includes('M') || num.includes('k') || num.includes('$'))) return num;
        return '$' + Math.round(Number(num)).toLocaleString();
    };

    window.onload = () => { uploadButton.disabled = false; chatInput.disabled = false; };
    uploadButton.addEventListener('click', () => !isProcessing && fileInput.click());
    modelSelectA.addEventListener('change', (e) => { selectedModel = e.target.value; });
    
    // Mode toggle handlers
    modeSingleBtn.addEventListener('click', () => setCompareMode(false));
    modeCompareBtn.addEventListener('click', () => setCompareMode(true));

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            uploadedFile = e.target.files[0];
            chatInput.value = `Ready to analyze: ${uploadedFile.name}`;
            sendButton.disabled = false;
        }
    });
    sendButton.addEventListener('click', handleSend);

    function handleSend() {
        if (!uploadedFile || isProcessing) return;
        isProcessing = true;
        sendButton.disabled = true;
        statusStep = 0;
        
        const fileName = uploadedFile.name;
        chatInput.value = '';
        chatInput.placeholder = "Processing...";

        if (compareMode) {
            handleCompareMode(fileName);
        } else {
            handleSingleMode(fileName);
        }
    }

    function handleSingleMode(fileName) {
        addMessage(`Uploaded ${fileName}`, 'user');
        addMessage(agentStatusMessages[0], 'agent-status');
        statusStep = 1;
        showLoading();

        const formData = new FormData();
        formData.append('file', uploadedFile);
        formData.append('model', modelSelectA.value);

        fetch(API_ENDPOINT, { method: 'POST', body: formData })
        .then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            function read() {
                reader.read().then(({done, value}) => {
                    if (done) {
                        isProcessing = false;
                        removeLoading();
                        resetUI();
                        return;
                    }
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    lines.forEach(line => {
                        if (line.startsWith('event: ')) {
                            const type = line.split('\n')[0].replace('event: ', '').trim();
                            const dataStr = line.split('data: ')[1];
                            
                            if (type === 'status') {
                                removeLoading();
                                addMessage(dataStr, 'agent-status');
                                showLoading();
                            }
                            else if (type === 'error') {
                                removeLoading();
                                addMessage("Error processing file.", 'error');
                            }
                            else if (type === 'router') {
                                removeLoading();
                                showLoading();
                            }
                            else if (type === 'bond_step_1') {
                                const data = JSON.parse(dataStr);
                                renderBondWidget1(data);
                            }
                            else if (type === 'bond_step_2') {
                                const data = JSON.parse(dataStr);
                                renderBondWidget2(data);
                            }
                            else if (type === 'bond_step_3') {
                                const data = JSON.parse(dataStr);
                                renderBondWidget3(data);
                            }
                            else if (type === 'result_bond_final') {
                                fullAnalysisContext = JSON.parse(dataStr);
                                if (fullAnalysisContext.metrics) {
                                    const metricsDiv = document.createElement('div');
                                    metricsDiv.className = 'mb-4';
                                    metricsDiv.innerHTML = renderMetricsWidget(fullAnalysisContext.metrics);
                                    messagesWindow.appendChild(metricsDiv);
                                    messagesWindow.scrollTop = messagesWindow.scrollHeight;
                                }
                                if(window.saveAnalysis) window.saveAnalysis(fullAnalysisContext);
                            }
                            else if (type === 'result_wip') {
                                removeLoading();
                                const payload = JSON.parse(dataStr);
                                const data = payload.data;
                                fullAnalysisContext = payload;
                                renderResults(data);
                                if(window.saveAnalysis) window.saveAnalysis(data);
                            }
                            else if (type === 'result') {
                                removeLoading();
                                const data = JSON.parse(dataStr);
                                renderResults(data);
                                if(window.saveAnalysis) window.saveAnalysis(data);
                            }
                        }
                    });
                    read();
                });
            }
            read();
        });
    }

    function handleCompareMode(fileName) {
        // Clear previous compare results
        comparePanelA.innerHTML = '';
        comparePanelB.innerHTML = '';
        
        const modelA = modelSelectA.value;
        const modelB = modelSelectB.value;
        
        // Update header names
        const modelNames = {
            'gemini-3-pro': 'Gemini 3 Pro',
            'claude-sonnet-4-5': 'Claude Sonnet 4.5',
            'claude-haiku-4-5': 'Claude Haiku 4.5',
            'claude-opus-4-5': 'Claude Opus 4.5'
        };
        compareModelAName.textContent = modelNames[modelA] || modelA;
        compareModelBName.textContent = modelNames[modelB] || modelB;
        
        // Show initial status in both panels
        addCompareMessage('a', 'Starting analysis...', 'agent-status');
        addCompareMessage('b', 'Starting analysis...', 'agent-status');
        showCompareLoading('a');
        showCompareLoading('b');
        
        let completedCount = 0;
        const checkComplete = () => {
            completedCount++;
            if (completedCount >= 2) {
                isProcessing = false;
                resetUI();
            }
        };
        
        // Read file into memory so we can send it twice
        const reader = new FileReader();
        reader.onload = function(e) {
            const fileBytes = e.target.result;
            const fileBlob = new Blob([fileBytes], { type: uploadedFile.type });
            
            // Start both streams with independent file copies
            startCompareStream('a', modelA, new File([fileBlob], uploadedFile.name, { type: uploadedFile.type }), checkComplete);
            startCompareStream('b', modelB, new File([fileBlob], uploadedFile.name, { type: uploadedFile.type }), checkComplete);
        };
        reader.readAsArrayBuffer(uploadedFile);
    }

    function startCompareStream(panel, model, file, onComplete) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('model', model);
        
        fetch(API_ENDPOINT, { method: 'POST', body: formData })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            function read() {
                reader.read().then(({done, value}) => {
                    if (done) {
                        removeCompareLoading(panel);
                        onComplete();
                        return;
                    }
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    lines.forEach(line => {
                        if (line.startsWith('event: ')) {
                            const type = line.split('\n')[0].replace('event: ', '').trim();
                            const dataStr = line.split('data: ')[1];
                            
                            if (type === 'status') {
                                removeCompareLoading(panel);
                                addCompareMessage(panel, dataStr, 'agent-status');
                                showCompareLoading(panel);
                            }
                            else if (type === 'error') {
                                removeCompareLoading(panel);
                                addCompareMessage(panel, "Error processing file.", 'error');
                            }
                            else if (type === 'bond_step_1') {
                                const data = JSON.parse(dataStr);
                                renderCompareBondWidget1(panel, data);
                            }
                            else if (type === 'bond_step_2') {
                                const data = JSON.parse(dataStr);
                                renderCompareBondWidget2(panel, data);
                            }
                            else if (type === 'bond_step_3') {
                                const data = JSON.parse(dataStr);
                                renderCompareBondWidget3(panel, data);
                            }
                            else if (type === 'result_bond_final') {
                                const result = JSON.parse(dataStr);
                                if (result.metrics) {
                                    addCompareWidget(panel, renderMetricsWidget(result.metrics));
                                }
                            }
                            else if (type === 'result_wip') {
                                removeCompareLoading(panel);
                                const payload = JSON.parse(dataStr);
                                const data = payload.data;
                                renderCompareResults(panel, data);
                            }
                        }
                    });
                    read();
                });
            }
            read();
        })
        .catch(err => {
            console.error(`Stream ${panel} error:`, err);
            removeCompareLoading(panel);
            addCompareMessage(panel, `Error: ${err.message}`, 'error');
            onComplete();
        });
    }

    // Compare mode helper functions
    function getComparePanel(panel) {
        return panel === 'a' ? comparePanelA : comparePanelB;
    }

    function addCompareMessage(panel, text, type) {
        const container = getComparePanel(panel);
        const div = document.createElement('div');
        div.className = 'mb-2';
        if (type === 'agent-status') {
            div.innerHTML = `<div class="agent-status">${text}</div>`;
        } else {
            div.innerHTML = `<div class="ai-message">${text}</div>`;
        }
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addCompareWidget(panel, html) {
        const container = getComparePanel(panel);
        const div = document.createElement('div');
        div.innerHTML = html;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    let compareLoadingA = null;
    let compareLoadingB = null;

    function showCompareLoading(panel) {
        const container = getComparePanel(panel);
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'agent-status mb-2 compare-loading';
        loadingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
        container.appendChild(loadingDiv);
        container.scrollTop = container.scrollHeight;
        
        if (panel === 'a') compareLoadingA = loadingDiv;
        else compareLoadingB = loadingDiv;
    }

    function removeCompareLoading(panel) {
        const loadingDiv = panel === 'a' ? compareLoadingA : compareLoadingB;
        if (loadingDiv) {
            loadingDiv.remove();
            if (panel === 'a') compareLoadingA = null;
            else compareLoadingB = null;
        }
    }

    function renderCompareResults(panel, data) {
        const container = getComparePanel(panel);
        const wd = data.widget_data;
        const m = wd.metrics;

        // Validation Widget
        const valDiv = document.createElement('div');
        valDiv.innerHTML = renderValidationWidget(wd.validations);
        container.appendChild(valDiv);

        // Dashboard Widget
        const dashDiv = document.createElement('div');
        dashDiv.innerHTML = renderDashboardWidget(wd, m);
        container.appendChild(dashDiv);

        // Metrics Widget
        if (data.metrics) {
            const metricsDiv = document.createElement('div');
            metricsDiv.innerHTML = renderMetricsWidget(data.metrics);
            container.appendChild(metricsDiv);
        }

        setupCollapsibles();
        container.scrollTop = container.scrollHeight;
    }

    function renderCompareBondWidget1(panel, data) {
        const container = getComparePanel(panel);
        const p = data.parties;
        const r = data.risks;
        
        const html = `
        <div class="widget-card">
            <div class="widget-header">
                <span class="font-semibold">Bond Analysis</span>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="widget-content">
                <div style="padding: 16px;">
                    <div class="bond-grid">
                        <div class="bond-cell">
                            <div class="bond-label">Principal</div>
                            <div class="bond-value" style="font-size: 0.85rem;">${p.principal_name}</div>
                        </div>
                        <div class="bond-cell">
                            <div class="bond-label">Obligee</div>
                            <div class="bond-value" style="font-size: 0.85rem;">${p.obligee_name}</div>
                        </div>
                        <div class="bond-cell">
                            <div class="bond-label">Penal Sum</div>
                            <div class="bond-value" style="font-size: 0.85rem;">${p.penal_sum}</div>
                        </div>
                        <div class="bond-cell">
                            <div class="bond-label">Bond Type</div>
                            <div class="bond-value" style="font-size: 0.85rem;">${r.bond_type}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        
        const div = document.createElement('div');
        div.innerHTML = html;
        container.appendChild(div);
        setupCollapsibles();
    }

    function renderCompareBondWidget2(panel, statutes) {
        const container = getComparePanel(panel);
        if (!statutes || statutes.length === 0) return;
        
        const html = `
        <div class="widget-card">
            <div class="widget-header">
                <span class="font-semibold">Statutes (${statutes.length})</span>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="widget-content">
                <div style="padding: 16px; font-size: 0.85rem; color: #d1d5db;">
                    ${statutes.map(s => s.citation).join(', ')}
                </div>
            </div>
        </div>`;
        
        const div = document.createElement('div');
        div.innerHTML = html;
        container.appendChild(div);
        setupCollapsibles();
    }

    function renderCompareBondWidget3(panel, op) {
        const container = getComparePanel(panel);
        
        const html = `
        <div class="widget-card">
            <div class="widget-header">
                <span class="font-semibold">Opinion: ${op.recommendation}</span>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="widget-content">
                <div style="padding: 16px;">
                    <div style="margin-bottom: 12px;">
                        <div class="bond-label">Bond Description</div>
                        <div class="bond-value" style="font-size: 0.85rem;">${op.bond_description}</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div class="bond-label">Who Must Post</div>
                        <div class="bond-value-sm">${op.who_must_post}</div>
                    </div>
                    <div>
                        <div class="bond-label">Cancellation</div>
                        <div class="bond-value-sm">${op.cancellation_summary}</div>
                    </div>
                </div>
            </div>
        </div>`;
        
        const div = document.createElement('div');
        div.innerHTML = html;
        container.appendChild(div);
        setupCollapsibles();
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = 'mb-4 fade-in';
        
        if (type === 'user') {
            div.innerHTML = `<div class="user-message user-message-anim">${text}</div>`;
        } else if (type === 'agent-status') {
            div.innerHTML = `<div class="agent-status">${text}</div>`;
        } else {
            div.innerHTML = `<div class="ai-message">${text}</div>`;
        }
        messagesWindow.appendChild(div);
        messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }

    function showLoading() {
        if (currentLoadingDiv) return;
        currentLoadingDiv = document.createElement('div');
        currentLoadingDiv.className = 'agent-status mb-4';
        currentLoadingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
        messagesWindow.appendChild(currentLoadingDiv);
        messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }

    function removeLoading() {
        if (currentLoadingDiv) {
            currentLoadingDiv.remove();
            currentLoadingDiv = null;
        }
    }

    function resetUI() {
        fileInput.value = ''; 
        uploadedFile = null;
        chatInput.value = '';
        chatInput.placeholder = "Message Wipple";
        uploadButton.disabled = false;
        chatInput.disabled = false;
    }

    function renderMetricsWidget(metrics) {
        if (!metrics || !metrics.model_name) return '';
        
        const time = metrics.total_time_seconds || 0;
        const tokens = metrics.tokens || {};
        const cost = metrics.cost_usd || 0;
        const calls = metrics.api_calls || 0;
        
        const timeStr = time < 60 ? `${time.toFixed(1)}s` : `${(time / 60).toFixed(1)}m`;
        const tokensStr = (tokens.total || 0).toLocaleString();
        const costStr = cost < 0.01 ? `$${(cost * 100).toFixed(2)}c` : `$${cost.toFixed(4)}`;
        
        return `
            <div class="metrics-widget">
                <div>
                    <div class="metrics-widget-title">Analyzed with</div>
                    <div class="metrics-model-name">${metrics.model_display_name || metrics.model_name}</div>
                </div>
                <div class="metrics-stats">
                    <div class="metrics-stat">
                        <div class="metrics-stat-value">${timeStr}</div>
                        <div class="metrics-stat-label">Time</div>
                    </div>
                    <div class="metrics-stat">
                        <div class="metrics-stat-value">${tokensStr}</div>
                        <div class="metrics-stat-label">Tokens</div>
                    </div>
                    <div class="metrics-stat">
                        <div class="metrics-stat-value">${calls}</div>
                        <div class="metrics-stat-label">API Calls</div>
                    </div>
                </div>
                <div class="metrics-cost">
                    <div class="metrics-cost-value">${costStr}</div>
                    <div class="metrics-cost-label">Cost</div>
                </div>
            </div>
        `;
    }

    function renderResults(data) {
        const wd = data.widget_data;
        const m = wd.metrics;
        lastTableData = data.clean_table;
        lastCalculatedTotals = data.calculated_totals;

        // 1. Validation Widget
        const valDiv = document.createElement('div');
        valDiv.innerHTML = renderValidationWidget(wd.validations);
        messagesWindow.appendChild(valDiv);

        // 2. Dashboard Widget
        const dashDiv = document.createElement('div');
        dashDiv.innerHTML = renderDashboardWidget(wd, m);
        messagesWindow.appendChild(dashDiv);

        // 3. Full Table Widget
        const tableDiv = document.createElement('div');
        tableDiv.innerHTML = renderTableWidget(data.clean_table, lastCalculatedTotals);
        messagesWindow.appendChild(tableDiv);

        // 4. Metrics Widget
        if (data.metrics) {
            const metricsDiv = document.createElement('div');
            metricsDiv.innerHTML = renderMetricsWidget(data.metrics);
            messagesWindow.appendChild(metricsDiv);
        }
        
        setupCollapsibles();
    }

    function renderValidationWidget(vals) {
        if (!vals) return '';
        
        const genId = () => 'val-' + Math.random().toString(36).substr(2, 9);

        // Build the job issues section for formulaic validation
        const buildJobIssuesHtml = (jobIssues) => {
            if (!jobIssues || jobIssues.length === 0) return '';
            
            return jobIssues.map((job, idx) => {
                const errorCount = job.errors.length;
                const correctionCount = job.corrections.length;
                const summaryParts = [];
                if (errorCount > 0) summaryParts.push(`${errorCount} validation${errorCount > 1 ? 's' : ''} failed`);
                if (correctionCount > 0) summaryParts.push(`${correctionCount} suggested fix${correctionCount > 1 ? 'es' : ''}`);
                
                const errorsHtml = job.errors.map(e => 
                    `<div class="error-line"> ${e.message}</div>`
                ).join('');
                
                const correctionsHtml = job.corrections.map(c => {
                    const confidenceClass = c.confidence === 'high' ? 'confidence-high' : 
                                           c.confidence === 'medium' ? 'confidence-medium' : 'confidence-low';
                    return `
                        <div class="correction-line">
                            <span class="correction-arrow"></span>
                            <span class="correction-text">
                                <strong>Suggested fix:</strong> Change ${c.field} from ${c.current} to ${c.suggested}
                                <span class="confidence-badge ${confidenceClass}">${c.confidence}</span>
                            </span>
                            <div class="correction-reasoning">${c.reasoning}</div>
                        </div>
                    `;
                }).join('');
                
                // Flat structure - no nested expand
                return `
                    <div class="job-issue-flat">
                        <div class="job-issue-header-flat">
                            <span class="job-issue-id">${job.jobId}</span>
                            <span class="job-issue-summary">${summaryParts.join(', ')}</span>
                        </div>
                        <div class="job-issue-content">
                            ${errorsHtml}
                            ${correctionsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        };

        const renderRow = (label, obj, isFormulaic = false) => {
            const hasDetails = (obj.details && obj.details.length > 0) || (isFormulaic && obj.jobIssues && obj.jobIssues.length > 0);
            const rowId = genId();
            const expandableClass = hasDetails ? 'expandable' : '';
            const bgClass = obj.passed ? 'val-row-pass' : 'val-row-fail';
            const statusClass = obj.passed ? 'val-pass' : 'val-fail';
            
            let detailsHtml = '';
            if (hasDetails) {
                if (isFormulaic && obj.jobIssues && obj.jobIssues.length > 0) {
                    detailsHtml = `<div id="${rowId}-details" class="val-details">${buildJobIssuesHtml(obj.jobIssues)}</div>`;
                } else if (obj.details && obj.details.length > 0) {
                    const items = obj.details.map(d => `<div class="val-error-item"><span class="font-bold text-white mr-2">${d.id}:</span>${d.msg}</div>`).join('');
                    detailsHtml = `<div id="${rowId}-details" class="val-details">${items}</div>`;
                }
            }

            const onClick = hasDetails ? `onclick="toggleValidationDetails('${rowId}')"` : '';
            const icon = hasDetails ? `<svg id="${rowId}-icon" class="val-expand-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>` : '';
            
            const statusIcon = obj.passed ? 
                '<svg class="mr-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>' : 
                '<svg class="mr-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

            return `
                <div class="validation-row ${bgClass} ${expandableClass}" ${onClick}>
                    <div class="val-header">
                        <div class="text-gray-300 text-sm font-medium">${label}</div>
                        <div class="val-status ${statusClass} flex items-center">
                            ${statusIcon}
                            <span>${obj.message}</span>
                            ${icon}
                        </div>
                    </div>
                    ${detailsHtml}
                </div>
            `;
        };

        return `
            <div class="widget-card">
                <div class="widget-header" id="header-val">
                    <span class="font-semibold">Data Integrity Check</span>
                    <svg id="icon-val" class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="widget-content" id="content-val">
                    ${renderRow("Formulaic Validation", vals.formulaic, true)}
                    ${renderRow("Totals Validation", vals.totals)}
                    ${renderRow("Structural Validation", vals.structural)}
                </div>
            </div>`;
    }
    
    window.toggleJobIssue = (id) => {
        const details = document.getElementById(id + '-details');
        const icon = document.getElementById(id + '-icon');
        if (!details) return;
        
        details.classList.toggle('open');
        if(icon) icon.classList.toggle('rotated');
    };
    
    function toggleValidationDetails(rowId) {
        const details = document.getElementById(rowId + '-details');
        const icon = document.getElementById(rowId + '-icon');
        if (!details) return;
        
        details.classList.toggle('open');
        if(icon) icon.classList.toggle('rotated');
        
        const parent = details.closest('.widget-content');
        if(parent && !parent.classList.contains('collapsed')) {
            parent.style.height = 'auto';
        }
    }

    function renderDashboardWidget(data, m) {
        // Portfolio risk tier badge
        const riskTier = data.riskTier || 'LOW';
        const tierClass = riskTier === 'HIGH' ? 'portfolio-tier-high' : 
                         riskTier === 'MODERATE' ? 'portfolio-tier-moderate' : 'portfolio-tier-low';
        
        const kpis = `
            <div class="kpi-grid">
                <div class="kpi-box"><div class="kpi-label">${m.row1_1.label}</div><div class="kpi-value">${m.row1_1.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row1_2.label}</div><div class="kpi-value">${m.row1_2.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row1_3.label}</div><div class="kpi-value">${m.row1_3.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row2_1.label}</div><div class="kpi-value">${m.row2_1.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row2_2.label}</div><div class="kpi-value">${m.row2_2.value}</div></div>
                <div class="kpi-box"><div class="kpi-label">${m.row2_3.label}</div><div class="kpi-value" style="color:${m.row2_3.value.includes('Over')?'#10b981':'#ef4444'}">${m.row2_3.value}</div></div>
            </div>`;

        let riskRows = '';
        if (data.riskRowsAll && data.riskRowsAll.length > 0) {
            data.riskRowsAll.forEach((r, i) => {
                const riskId = `risk-${i}`;
                const tierClass = r.riskTier === 'HIGH' ? 'risk-tier-high' : 
                                 r.riskTier === 'MEDIUM' ? 'risk-tier-medium' : 'risk-tier-low';
                
                // Build detail items
                let detailsHtml = '';
                if (r.riskDetails && r.riskDetails.length > 0) {
                    detailsHtml = r.riskDetails.map(d => `
                        <div class="risk-detail-item">
                            <div class="risk-detail-tag">${d.tag}</div>
                            <div class="risk-detail-summary">${d.summary}</div>
                            <div class="risk-detail-explanation">${d.detail}</div>
                        </div>
                    `).join('');
                }
                
                riskRows += `
                    <div class="risk-row" onclick="toggleRisk('${riskId}')">
                        <div>
                            <div class="font-semibold flex items-center">
                                ${r.jobId}
                                <svg class="risk-expand-icon" id="${riskId}-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                            </div>
                            <div class="text-xs job-name-bold">${r.jobName || 'No Name'}</div>
                        </div>
                        <div class="text-gray-300 text-xs" style="padding-right: 12px;">${r.riskTags}</div>
                        <div><span class="risk-tier ${tierClass}">${r.riskTier}</span></div>
                    </div>
                    <div id="${riskId}" class="risk-details">
                        ${detailsHtml}
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); color: #8e8ea0; font-size: 0.8rem;">
                            <strong>Completion:</strong> ${r.percentComplete}
                        </div>
                    </div>`;
            });
        } else {
            riskRows = '<div style="padding: 16px; color: #8e8ea0; text-align: center;">No significant risks identified</div>';
        }

        return `
            <div class="widget-card">
                <div class="widget-header" id="header-dash">
                    <div class="flex items-center">
                        <span class="font-semibold">WIP Health Summary</span>
                        <span class="portfolio-tier-badge ${tierClass}">${riskTier} RISK</span>
                    </div>
                    <svg id="icon-dash" class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="widget-content" id="content-dash">
                    <div class="p-4">
                        <div class="wip-summary"><h4>Portfolio Overview</h4><p>${data.summary ? data.summary.text : 'Analysis complete.'}</p></div>
                        ${kpis}
                        <div>
                            <h4 class="text-sm font-semibold text-gray-400 mb-3">Top Risks</h4>
                            <div class="risk-table">
                                <div class="risk-header">
                                    <div>Job</div>
                                    <div>Risk Type(s)</div>
                                    <div>Tier</div>
                                </div>
                                ${riskRows}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function renderTableWidget(rows, totals) {
        if(!rows || rows.length === 0) return '';
        let trs = rows.map(r => `
            <tr>
                <td class="font-mono text-xs">${r.job_id}</td>
                <td class="text-gray-400 text-xs" title="${r.job_name}">${r.job_name || '--'}</td>
                <td class="text-right">${fmt(r.total_contract_price)}</td>
                <td class="text-right">${fmt(r.estimated_total_costs)}</td>
                <td class="text-right">${fmt(r.estimated_gross_profit)}</td>
                <td class="text-right">${fmt(r.billed_to_date)}</td>
                <td class="text-right">${fmt(r.cost_to_date)}</td>
                <td class="text-right text-red-400">${r.under_billings > 0 ? fmt(r.under_billings) : '-'}</td>
                <td class="text-right text-green-400">${r.over_billings > 0 ? fmt(r.over_billings) : '-'}</td>
                <td class="text-right">${fmt(r.uegp)}</td>
                <td class="text-right">${fmt(r.cost_to_complete)}</td>
            </tr>`).join('');

        if (totals) {
            trs += `
            <tr class="totals-row">
                <td>TOTAL</td>
                <td></td>
                <td class="text-right">${fmt(totals.total_contract_price)}</td>
                <td class="text-right">${fmt(totals.estimated_total_costs)}</td>
                <td class="text-right">${fmt(totals.estimated_gross_profit)}</td>
                <td class="text-right">${fmt(totals.billed_to_date)}</td>
                <td class="text-right">${fmt(totals.cost_to_date)}</td>
                <td class="text-right text-red-400">${fmt(totals.under_billings)}</td>
                <td class="text-right text-green-400">${fmt(totals.over_billings)}</td>
                <td class="text-right">${fmt(totals.uegp)}</td>
                <td class="text-right">${fmt(totals.cost_to_complete)}</td>
            </tr>`;
        }

        const tableId = 'tbl-' + Math.random().toString(36).substr(2, 9);

        return `
             <div class="widget-card" id="card-${tableId}">
                <div class="widget-header" id="header-${tableId}" style="padding-right: 8px;">
                    <span class="font-semibold flex-1">Validated WIP (${rows.length} Rows)</span>
                    <button onclick="toggleMaximize('${tableId}', event)" class="btn-max" title="Maximize">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                    </button>
                    <button onclick="downloadCSV(event)" class="btn-download">Download CSV</button>
                    <svg id="icon-${tableId}" class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="widget-content collapsed" id="content-${tableId}" style="height: 0px;">
                    <div class="data-table" style="max-height: 400px; overflow-y: auto;">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>ID</th><th>Name</th><th class="text-right">Contract</th>
                                    <th class="text-right">Est Cost</th><th class="text-right">Est GP</th>
                                    <th class="text-right">Billed</th><th class="text-right">Costs</th>
                                    <th class="text-right">UB</th><th class="text-right">OB</th>
                                    <th class="text-right">UEGP</th><th class="text-right">CTC</th>
                                </tr>
                            </thead>
                            <tbody>${trs}</tbody>
                        </table>
                    </div>
                </div>
            </div>`;
    }

    function toggleMaximize(id, e) {
        e.stopPropagation();
        const card = document.getElementById(`card-${id}`);
        const backdrop = document.getElementById('modal-backdrop');
        
        if(card.classList.contains('maximized')) {
            card.classList.remove('maximized');
            backdrop.classList.remove('active');
        } else {
            card.classList.add('maximized');
            backdrop.classList.add('active');
            const content = document.getElementById(`content-${id}`);
            content.classList.remove('collapsed');
            content.style.height = 'auto';
        }
    }

    function downloadCSV(e) {
        e.stopPropagation(); 
        if (!lastTableData || !lastTableData.length) return;
        
        const headers = [
            "job_id", "job_name", "total_contract_price", "estimated_total_costs", "estimated_gross_profit",
            "billed_to_date", "cost_to_date", "under_billings", "over_billings", "uegp", "cost_to_complete"
        ];
        
        const csvRows = [headers.join(',')];
        
        for (const row of lastTableData) {
            const values = headers.map(header => {
                const val = row[header];
                return `"${('' + val).replace(/"/g, '""')}"`;
            });
            csvRows.push(values.join(','));
        }
        
        if (lastCalculatedTotals) {
            const totalValues = headers.map(header => {
                if (header === 'job_id') return '"TOTALS"';
                if (header === 'job_name') return '""';
                const val = lastCalculatedTotals[header] || 0;
                return `"${val}"`;
            });
            csvRows.push(totalValues.join(','));
        }
        
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'wip_extract.csv'; a.click();
    }

    function toggleRisk(id) {
        const el = document.getElementById(id);
        const icon = document.getElementById(id + '-icon');
        el.classList.toggle('expanded');
        if(icon) icon.classList.toggle('expanded');
    }

    function setupCollapsibles() {
        const widgets = document.querySelectorAll('.widget-card');
        widgets.forEach(widget => {
            const header = widget.querySelector('.widget-header');
            const content = widget.querySelector('.widget-content');
            const icon = widget.querySelector('.collapse-icon');
            
            if(!header || !content) return;
            
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            
            newHeader.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    content.style.height = content.scrollHeight + "px";
                    if(icon) icon.classList.remove('collapsed');
                    setTimeout(() => { if(!content.classList.contains('collapsed')) content.style.height = 'auto'; }, 300);
                } else {
                    content.style.height = content.scrollHeight + "px";
                    content.offsetHeight; 
                    content.classList.add('collapsed');
                    content.style.height = "0px";
                    if(icon) icon.classList.add('collapsed');
                }
            });
        });
    }

    // === BOND WIDGET RENDERERS (unchanged) ===

    function renderBondWidget1(data) {
        const p = data.parties;
        const r = data.risks;
        
        const html = `
        <div class="widget-card">
            <div class="widget-header">
                <span class="font-semibold">Bond Analysis & Risk Terms</span>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="widget-content">
                <div style="margin-bottom: 24px; padding: 20px 20px 0 20px;">
                    <h4 style="color: #ffffff; font-size: 1.125rem; font-weight: 700; margin-bottom: 12px;">Parties Involved</h4>
                    <div class="bond-grid">
                        <div class="bond-cell">
                            <div class="bond-label">Principal</div>
                            <div class="bond-value">${p.principal_name}</div>
                        </div>
                        <div class="bond-cell">
                            <div class="bond-label">Obligee</div>
                            <div class="bond-value">${p.obligee_name}</div>
                        </div>
                        <div class="bond-cell">
                            <div class="bond-label">Surety</div>
                            <div class="bond-value">${p.surety_name || 'Not Specified'}</div>
                        </div>
                        <div class="bond-cell">
                            <div class="bond-label">Penal Sum</div>
                            <div class="bond-value">${p.penal_sum}</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0 20px 20px 20px;">
                    <h4 style="color: #ffffff; font-size: 1.125rem; font-weight: 700; margin-bottom: 12px;">Key Risk Clauses</h4>
                    <div class="bond-risk-list">
                        <div class="bond-risk-item">
                            <div class="bond-label">Security Required</div>
                            <div class="bond-value-sm">${r.security_required}</div>
                        </div>
                        <div class="bond-risk-item">
                            <div class="bond-label">Type</div>
                            <div class="bond-value-sm">${r.bond_type}</div>
                        </div>
                        <div class="bond-risk-item">
                            <div class="bond-label">Forms Provided</div>
                            <div class="bond-value-sm">${r.forms_provided}</div>
                        </div>
                        <div class="bond-risk-item">
                            <div class="bond-label">Adjustable Amount</div>
                            <div class="bond-value-sm">${r.adjustable_amount}</div>
                        </div>
                        <div class="bond-risk-item">
                            <div class="bond-label">Cancellation Notice</div>
                            <div class="bond-value-sm">${r.cancellation_notice_period}</div>
                        </div>
                        <div class="bond-risk-item">
                            <div class="bond-label">Effective Duration</div>
                            <div class="bond-value-sm">${r.effective_duration}</div>
                        </div>
                        <div class="bond-risk-item">
                            <div class="bond-label">Quick Payment Terms</div>
                            <div class="bond-value-sm">${r.quick_payment_terms}</div>
                        </div>
                        <div class="bond-risk-item">
                            <div class="bond-label">Efficiency Guarantees</div>
                            <div class="bond-value-sm">${r.efficiency_guarantees}</div>
                        </div>
                        <div class="bond-risk-item">
                            <div class="bond-label">Enforcement Mechanisms</div>
                            <div class="bond-value-sm">${r.enforcement_mechanisms}</div>
                        </div>
                        <div class="bond-risk-item" style="border: none;">
                            <div class="bond-label">Cancellation Terms</div>
                            <div class="bond-value-sm" style="font-style: italic; color: #d1d5db;">"${r.cancellation_terms}"</div>
                        </div>
                        <div class="bond-risk-item" style="border: none;">
                            <div class="bond-label">Forfeiture Language</div>
                            <div class="bond-value-sm" style="font-style: italic; color: #d1d5db;">${r.forfeiture_language}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        
        addMessage(html, 'widget');
        setupCollapsibles();
    }

    function renderBondWidget2(statutes) {
        if (!statutes || statutes.length === 0) {
            const html = `
            <div class="widget-card">
                <div class="widget-header">
                    <span class="font-semibold">Statutory References & Compliance</span>
                    <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="widget-content">
                    <div style="padding: 20px;">
                        <div style="color: #8e8ea0; font-size: 0.875rem;">No specific statutes cited in this bond.</div>
                    </div>
                </div>
            </div>`;
            addMessage(html, 'widget');
            setupCollapsibles();
            return;
        }

        const items = statutes.map((s, idx) => {
            const hasExcerpt = s.verbatim_text && s.verbatim_text !== 'Excerpt not found.';
            const hasSummary = s.plain_summary && s.plain_summary.length > 0;
            
            return `
                <div class="statute-item">
                    <div class="statute-header" onclick="toggleStatute(${idx})">
                        <div>
                            <div class="statute-citation-text">${s.citation}</div>
                            <div class="statute-name">${s.name}</div>
                        </div>
                        <svg id="statute-icon-${idx}" class="statute-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </div>
                    <div id="stat-${idx}" class="statute-details-container">
                        ${hasSummary ? `
                            <div style="margin-bottom: 12px;">
                                <div class="statute-section-label">SUMMARY</div>
                                <div class="statute-text">${s.plain_summary}</div>
                            </div>
                        ` : ''}
                        ${hasExcerpt ? `
                            <div style="margin-bottom: 12px;">
                                <div class="statute-section-label">VERBATIM TEXT</div>
                                <div class="statute-verbatim">${s.verbatim_text}</div>
                            </div>
                        ` : ''}
                        ${s.source_link ? `
                            <a href="${s.source_link}" target="_blank" class="statute-link">
                                View Official Source 
                            </a>
                        ` : ''}
                        ${!hasExcerpt && !hasSummary ? `
                            <div class="statute-text" style="color: #8e8ea0;">Statute identified but unable to retrieve official excerpt.</div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');

        const html = `
        <div class="widget-card">
            <div class="widget-header">
                <span class="font-semibold">Statutory References & Compliance</span>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="widget-content">
                <div style="padding: 20px;">
                    ${items}
                </div>
            </div>
        </div>`;
        
        addMessage(html, 'widget');
        setupCollapsibles();
    }

    window.toggleStatute = (idx) => {
        const el = document.getElementById(`stat-${idx}`);
        const icon = document.getElementById(`statute-icon-${idx}`);
        
        if (!el) return;
        
        if (el.classList.contains('open')) {
            el.classList.remove('open');
            if (icon) icon.classList.remove('rotated');
        } else {
            el.classList.add('open');
            if (icon) icon.classList.add('rotated');
        }
    };

    function renderBondWidget3(op) {
        const html = `
        <div class="widget-card">
            <div class="widget-header">
                <span class="font-semibold">Underwriting Opinion</span>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="widget-content">
                <div style="padding: 20px;">
                <div class="opinion-header-grid">
                    <div class="opinion-field">
                        <div class="bond-label">Risk State</div>
                        <div class="bond-value">${op.risk_state}</div>
                    </div>
                    <div class="opinion-field">
                        <div class="bond-label">Obligee</div>
                        <div class="bond-value">${op.obligee}</div>
                    </div>
                    <div class="opinion-field">
                        <div class="bond-label">Bond Description</div>
                        <div class="bond-value">${op.bond_description}</div>
                    </div>
                    <div class="opinion-field">
                        <div class="bond-label">SFAA No. / Descriptor</div>
                        <div class="bond-value">${op.sfaa_descriptor}</div>
                    </div>
                    <div class="opinion-field">
                        <div class="bond-label">Penalty</div>
                        <div class="bond-value">${op.penalty}</div>
                    </div>
                    <div class="opinion-field" style="grid-column: span 1;">
                        <div class="bond-label">Statutory References</div>
                        <div class="bond-value-sm">${op.statutory_references.join(', ')}</div>
                    </div>
                </div>
                <div style="margin-top: 24px;">
                    <h4 style="color: #ffffff; font-size: 1.125rem; font-weight: 700; margin-bottom: 16px;">Legal Opinion</h4>
                    <div class="opinion-section">
                        <div class="opinion-subsection">
                            <div class="opinion-label">Who Must Post Bond</div>
                            <div class="opinion-text">${op.who_must_post}</div>
                        </div>
                        <div class="opinion-subsection">
                            <div class="opinion-label">Statutory Definitions</div>
                            <div class="opinion-text">${op.statutory_definitions}</div>
                        </div>
                        <div class="opinion-subsection">
                            <div class="opinion-label">Exemptions</div>
                            <div class="opinion-text">${op.exemptions}</div>
                        </div>
                        <div class="opinion-subsection">
                            <div class="opinion-label">Bond Guarantees</div>
                            <div class="opinion-text">${op.bond_guarantees}</div>
                        </div>
                        <div class="opinion-subsection">
                            <div class="opinion-label">Licensing/Bonding Deadlines</div>
                            <div class="opinion-text">${op.deadlines_cycles}</div>
                        </div>
                        <div class="opinion-subsection">
                            <div class="opinion-label">Past Claims Experience</div>
                            <div class="opinion-text">${op.claims_history}</div>
                        </div>
                        <div class="opinion-subsection">
                            <div class="opinion-label">Alternative Instruments</div>
                            <div class="opinion-text">${op.alternative_instruments}</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 24px;">
                    <h4 style="color: #ffffff; font-size: 1.125rem; font-weight: 700; margin-bottom: 12px;">Cancellation Clause</h4>
                    
                    <div style="margin-bottom: 12px;">
                        <div class="statute-section-label">SUMMARY</div>
                        <div class="statute-text">${op.cancellation_summary}</div>
                    </div>
                    
                    <div>
                        <div class="statute-section-label">VERBATIM TEXT</div>
                        <div class="statute-verbatim">${op.cancellation_verbatim}</div>
                    </div>
                </div>
                </div>
            </div>
        </div>`;
        
        addMessage(html, 'widget');
        setupCollapsibles();
    }
</script>
</body>
</html>
