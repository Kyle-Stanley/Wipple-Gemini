<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wipple Financial Agent Demo</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* BASE & LAYOUT */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #212121;
        }
        
        /* Wipple Blue Accent */
        .text-whipple-blue { color: #00BFFF; }
        .bg-whipple-blue { background-color: #00BFFF; }
        
        /* SCROLLING - Clean scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #2d2d2d; }
        ::-webkit-scrollbar-thumb { 
            background-color: #565869; 
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background-color: #6e7080; 
        }

        /* Message styling - OpenAI-like */
        .messages-container {
            max-width: 768px;
            margin: 0 auto;
        }

        /* User messages */
        .user-message {
            background-color: #2f2f2f;
            color: #ececec;
            border-radius: 18px;
            padding: 10px 16px;
            max-width: 85%;
            margin-left: auto;
            word-wrap: break-word;
        }

        /* AI messages - no bubble */
        .ai-message {
            color: #ececec;
            max-width: 100%;
            padding: 0;
            line-height: 1.6;
        }

        /* Agent status messages */
        .agent-status {
            color: #8e8ea0;
            font-size: 0.875rem;
            padding: 0;
            margin: 8px 0;
        }

        /* Widget Card Styling */
        .widget-card {
            background: linear-gradient(180deg, #262626 0%, #212121 100%);
            border: 1px solid #3e3e4e;
            border-radius: 12px;
            margin: 16px 0;
        }

        .widget-header {
            padding: 12px 16px;
            border-bottom: 1px solid #3e3e4e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            color: #ececec;
        }

        .widget-header:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .widget-content {
            padding: 16px;
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }

        .widget-content.collapsed {
            max-height: 0;
            padding: 0 16px;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 640px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .kpi-box {
            background-color: #1a1a1a;
            border: 1px solid #3e3e4e;
            border-radius: 8px;
            padding: 12px;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: #8e8ea0;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ececec;
        }

        /* Risk Table */
        .risk-table {
            width: 100%;
            font-size: 0.875rem;
        }

        .risk-header {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1.5fr;
            padding: 8px 0;
            border-bottom: 1px solid #3e3e4e;
            color: #8e8ea0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1.5fr;
            padding: 10px 0;
            border-bottom: 1px solid rgba(62, 62, 78, 0.3);
            color: #ececec;
        }

        .risk-row:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .risk-level {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            width: fit-content;
        }

        .risk-high {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .risk-medium {
            background-color: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        /* FLIPPED COLORS:
           Overbilling = green (often cash-flow positive)
           Underbilling = red (worse from your POV) */
        .variance-ob {
            color: #10b981;  /* Green for overbilling */
        }

        .variance-ub {
            color: #ef4444;  /* Red for underbilling */
        }

        /* Risk detail expansion */
        .risk-expandable {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .risk-expandable:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .risk-details {
            grid-column: 1 / -1;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 0.875rem;
            line-height: 1.6;
            color: #a0a0a0;
            max-height: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, margin 0.3s ease-out;
        }

        .risk-details.expanded {
            max-height: 300px;
            padding: 12px 16px;
            margin-top: 8px;
        }

        .risk-expand-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-left: 8px;
            transition: transform 0.2s;
        }

        .risk-expand-icon.expanded {
            transform: rotate(180deg);
        }

        /* WIP Summary box */
        .wip-summary {
            background-color: rgba(0, 191, 255, 0.05);
            border-left: 3px solid #00BFFF;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .wip-summary h4 {
            color: #00BFFF;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .wip-summary p {
            color: #d0d0d0;
            line-height: 1.7;
            margin-bottom: 12px;
        }

        .wip-summary p:last-child {
            margin-bottom: 0;
        }

        /* Input Area */
        .input-container {
            background-color: #2f2f2f;
            border: 1.5px solid #565869;
            border-radius: 24px;
            transition: border-color 0.2s;
        }

        .input-container:focus-within {
            border-color: #565869;
        }

        #chat-input {
            background: transparent;
            border: none;
            outline: none;
            color: #ececec;
            padding: 12px 16px;
            font-size: 0.95rem;
        }

        #chat-input::placeholder {
            color: #8e8ea0;
        }

        #chat-input:disabled {
            opacity: 0.5;
        }

        /* Buttons */
        .icon-button {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            color: #8e8ea0;
        }

        .icon-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ececec;
        }

        .icon-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .send-button {
            background-color: #ececec;
            color: #212121;
        }

        .send-button:hover:not(:disabled) {
            background-color: #d4d4d8;
        }

        .send-button:disabled {
            background-color: #3f3f46;
        }

        /* Welcome message (intro) – bumped size, Whipple blue, more presence */
        .welcome-message {
            color: #00BFFF;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 14px;
            text-align: center;
            transition: opacity 0.3s, max-height 0.3s;
        }

        .welcome-message.hidden {
            opacity: 0;
            max-height: 0;
            margin: 0;
            overflow: hidden;
        }

        /* Collapse icon animation */
        .collapse-icon {
            transition: transform 0.3s;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        /* Table styling */
        .data-table {
            background-color: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table table {
            width: 100%;
            font-size: 0.875rem;
        }

        .data-table th {
            background-color: #2a2a2a;
            color: #8e8ea0;
            font-weight: 600;
            text-align: left;
            padding: 10px 12px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: #ececec;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(62, 62, 78, 0.3);
        }

        .data-table tr:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid #3f3f46;
            border-top: 2px solid #00BFFF;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Typing animation */
        .typing-animation {
            opacity: 0;
            animation: fadeIn 0.3s ease-in forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* User message animation - slide in from right */
        .user-message-animation {
            animation: slideInRight 0.3s ease-out forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .typing-dots {
            display: inline-block;
            margin-left: 4px;
        }

        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #8e8ea0;
            margin: 0 2px;
            animation: blink 1.4s infinite both;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 60%, 100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="min-h-screen overflow-y-auto">
    
    <!-- Header Bar -->
    <header class="h-16 flex items-center px-6 sticky top-0 z-30 bg-[#212121]">
        <img src="logo2_bw.png" alt="Wipple Logo" class="h-14" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <div class="text-xl font-semibold text-white hidden ml-2">Wipple Financial Agent</div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto pb-32">
        <!-- Messages Container -->
        <div id="messages-window" class="messages-container p-6">
            <!-- Messages will be appended here -->
        </div>
    </div>

    <!-- Input Area -->
    <div class="fixed bottom-0 left-0 right-0 z-30 p-4 bg-[#212121]">
        <div class="max-w-3xl mx-auto">
            <!-- Welcome Message -->
            <div id="welcome-message" class="welcome-message">
                Welcome to the Wipple Agent. Click the + icon below to upload your WIP report.
            </div>
            
            <!-- Input Container -->
            <div class="input-container flex items-center">
                <!-- Hidden File Input -->
                <input type="file" id="file-input" accept="application/pdf" class="hidden">
                
                <!-- Upload Button -->
                <button id="upload-button" class="icon-button ml-2">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>

                <!-- Text Input -->
                <input type="text" id="chat-input" placeholder="Message Wipple" disabled class="flex-1">
                
                <!-- Send Button -->
                <button id="send-button" class="icon-button send-button mr-2" disabled>
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M22 2L11 13L22 2L15 22L11 13L2 9L22 2Z" stroke-linejoin="round" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

<script>
    // Configuration
    const API_ENDPOINT = "https://wipple-gemini-production.up.railway.app/analyze-wip-stream";
    
    // DOM Elements
    const messagesWindow = document.getElementById('messages-window');
    const fileInput = document.getElementById('file-input');
    const uploadButton = document.getElementById('upload-button');
    const sendButton = document.getElementById('send-button');
    const chatInput = document.getElementById('chat-input');
    const welcomeMessage = document.getElementById('welcome-message');

    let uploadedFile = null;
    let isProcessing = false;

    // Agent status copy (fixed sequence)
    const agentStatusMessages = [
        "OCR Agent is scanning the document now...",
        "OCR was successful. Passing to Validation Agent to confirm table validity...",
        "Validations passed. Analyst Agent is preparing final analysis..."
    ];
    let statusStep = 0;

    // Initialize
    window.onload = () => {
        uploadButton.disabled = false;
        chatInput.disabled = false;
    };

    // Event Handlers
    uploadButton.addEventListener('click', () => {
        if (!isProcessing) fileInput.click();
    });

    fileInput.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
            uploadedFile = event.target.files[0];
            chatInput.value = `File selected: ${uploadedFile.name}`;
            sendButton.disabled = false;
        } else {
            uploadedFile = null;
            chatInput.value = '';
            sendButton.disabled = true;
        }
    });

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !sendButton.disabled) {
            handleSend();
        }
    });

    sendButton.addEventListener('click', handleSend);

    // Core Functions
    let currentLoadingDiv = null; // Track current loading indicator
    
    function handleSend() {
        if (!uploadedFile || isProcessing) return;

        // Hide welcome message
        welcomeMessage.classList.add('hidden');

        // Reset status step for new run
        statusStep = 0;

        // Lock UI
        sendButton.disabled = true;
        uploadButton.disabled = true;
        isProcessing = true;
        
        // Add user message
        addMessage(`Uploaded: ${uploadedFile.name}`, 'user');
        
        // Show loading indicator
        showLoadingIndicator();

        const formData = new FormData();
        formData.append('file', uploadedFile);

        fetchStream(formData);
    }
    
    function showLoadingIndicator() {
        // Remove any existing loading indicator
        if (currentLoadingDiv) {
            currentLoadingDiv.remove();
        }
        
        // Create new loading indicator
        currentLoadingDiv = document.createElement('div');
        currentLoadingDiv.className = 'mb-6 agent-status-container';
        currentLoadingDiv.innerHTML = `
            <div class="agent-status">
                <span class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </div>
        `;
        messagesWindow.appendChild(currentLoadingDiv);
        messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }
    
    function removeLoadingIndicator() {
        if (currentLoadingDiv) {
            currentLoadingDiv.remove();
            currentLoadingDiv = null;
        }
    }
    
    function fetchStream(formData) {
        fetch(API_ENDPOINT, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.body) throw new Error("No stream available.");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            function processStream({ done, value }) {
                if (done) {
                    removeLoadingIndicator(); // Clean up any remaining loading indicator
                    if (isProcessing) finalizeUI("Analysis complete");
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const parts = buffer.split('\n\n');
                buffer = parts.pop();

                parts.forEach(part => {
                    if (part.trim() === '') return;
                    
                    const event = parseSSE(part);
                    if (event) handleEvent(event);
                });

                return reader.read().then(processStream);
            }

            reader.read().then(processStream).catch(error => {
                addError(`Connection Error: ${error.message}`);
                finalizeUI("Failed due to connection error");
            });
        })
        .catch(error => {
            addError(`Network failure: ${error.message}`);
            finalizeUI("Failed due to network error");
        });
    }

    function parseSSE(data) {
        const lines = data.split('\n');
        let event = {};
        lines.forEach(line => {
            if (line.startsWith('event:')) {
                event.type = line.substring(6).trim();
            } else if (line.startsWith('data:')) {
                event.data = line.substring(5).trim();
            }
        });
        return event.type ? event : null;
    }

    function handleEvent(event) {
        if (event.type === 'status') {
            // Remove loading indicator and add the status message
            removeLoadingIndicator();

            // Use our curated messages in order; fall back to backend text if we run out
            const messageText = agentStatusMessages[statusStep] || event.data;
            statusStep++;

            addMessage(messageText, 'agent-status', true);
            // Show new loading indicator for next message
            showLoadingIndicator();
        } else if (event.type === 'result') {
            // Remove loading indicator before showing results
            removeLoadingIndicator();
            try {
                const payload = JSON.parse(event.data);
                // Check if widget_data exists and is not [object Object]
                if (payload.widget_data && typeof payload.widget_data === 'object') {
                    displayResults(payload.widget_data);
                } else {
                    // If widget_data is malformed, try to display what we can
                    addError(`Received malformed widget data from backend`);
                }
                finalizeUI("Message Wipple");
            } catch (e) {
                addError(`Failed to parse results: ${e.message}`);
                finalizeUI("Analysis failed");
            }
        } else if (event.type === 'error') {
            removeLoadingIndicator();
            addError(event.data);
            finalizeUI("Analysis failed");
        }
    }
    
    function addMessage(text, role, animate = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'mb-6';
        
        if (role === 'user') {
            messageDiv.className += ' flex justify-end';
            messageDiv.innerHTML = `<div class="user-message user-message-animation">${text}</div>`;
        } else if (role === 'agent-status') {
            messageDiv.className += ' agent-status-container';
            const animClass = animate ? 'typing-animation' : '';
            messageDiv.innerHTML = `<div class="agent-status ${animClass}">${text}</div>`;
        } else {
            const animClass = animate ? 'typing-animation' : '';
            messageDiv.innerHTML = `<div class="ai-message ${animClass}">${text}</div>`;
        }
        
        messagesWindow.appendChild(messageDiv);
        messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }

    function addError(errorText) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'mb-6';
        errorDiv.innerHTML = `
            <div class="widget-card" style="border-color: #ef4444;">
                <div class="widget-content" style="padding: 16px;">
                    <div class="text-red-400 font-semibold">Error</div>
                    <div class="text-gray-300 mt-2">${errorText}</div>
                </div>
            </div>
        `;
        messagesWindow.appendChild(errorDiv);
        messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }

    function finalizeUI(placeholder) {
        isProcessing = false;
        uploadButton.disabled = false;
        chatInput.disabled = false;
        sendButton.disabled = true;
        uploadedFile = null;
        fileInput.value = '';
        chatInput.placeholder = placeholder;
        chatInput.value = '';
        statusStep = 0;
    }
    
    function toggleWidget(widgetId) {
        const content = document.getElementById(widgetId);
        const icon = document.getElementById(widgetId + '-icon');
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            // Let content grow with inner expands so Top Risk details aren’t clipped
            content.style.maxHeight = 'none';
            icon.classList.remove('collapsed');
        } else {
            content.classList.add('collapsed');
            content.style.maxHeight = '0';
            icon.classList.add('collapsed');
        }
    }

    function displayResults(data) {
        // Add summary with animation
        const summaryText = data.summary?.text || data.summary || "Analysis complete.";
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'mb-6';
        summaryDiv.innerHTML = `<div class="ai-message typing-animation">${summaryText}</div>`;
        messagesWindow.appendChild(summaryDiv);

        // Add WIP Health Summary Widget with slight delay
        setTimeout(() => {
            const dashboardDiv = document.createElement('div');
            dashboardDiv.className = 'mb-6 typing-animation';
            dashboardDiv.innerHTML = renderDashboardWidget(data);
            messagesWindow.appendChild(dashboardDiv);

            // Add Data Table Widget with additional delay
            if (data.clean_table && data.clean_table.length > 0) {
                setTimeout(() => {
                    const tableDiv = document.createElement('div');
                    tableDiv.className = 'mb-6 typing-animation';
                    tableDiv.innerHTML = renderTableWidget(data.clean_table);
                    messagesWindow.appendChild(tableDiv);
                    
                    // Setup collapse handlers
                    setupCollapseHandlers();
                }, 200);
            } else {
                setupCollapseHandlers();
            }
        }, 300);

        messagesWindow.scrollTop = messagesWindow.scrollHeight;
    }

    function setupCollapseHandlers() {
        const dashboardHeader = document.querySelector('#dashboard-header');
        if (dashboardHeader) {
            dashboardHeader.addEventListener('click', () => toggleWidget('dashboard-content'));
        }
        
        const tableHeader = document.querySelector('#table-header');
        if (tableHeader) {
            tableHeader.addEventListener('click', () => toggleWidget('table-content'));
        }
    }

    function renderDashboardWidget(data) {
        const metrics = data.metrics || {};
        const risks = data.riskRowsAll || [];
        
        // Generate KPI boxes in specific order
        let kpiHtml = '';
        
        // Define exact order: Row 1: Total Contract, UEGP, CTC | Row 2: GP%, WIP GP%, CC GP%
        const orderedMetrics = [
            'total_contract', 'uegp', 'ctc',
            'gp_percent', 'wip_gp_percent', 'cc_gp_percent'
        ];
        
        // Add metrics in specific order
        orderedMetrics.forEach(key => {
            if (metrics[key]) {
                const metric = metrics[key];
                kpiHtml += `
                    <div class="kpi-box">
                        <div class="kpi-label">${metric.label}</div>
                        <div class="kpi-value">${metric.value}</div>
                    </div>
                `;
            }
        });
        
        // Add any remaining metrics not in the ordered list
        Object.keys(metrics).forEach(key => {
            if (!orderedMetrics.includes(key)) {
                const metric = metrics[key];
                kpiHtml += `
                    <div class="kpi-box">
                        <div class="kpi-label">${metric.label}</div>
                        <div class="kpi-value">${metric.value}</div>
                    </div>
                `;
            }
        });

        // Generate risk rows with expandable details (top 5)
        let riskHtml = '';
        risks.slice(0, 5).forEach((risk, index) => {
            const levelClass = risk.riskLevel === 'high' ? 'risk-high' : 'risk-medium';
            const varianceClass = risk.ubobType === 'OB' ? 'variance-ob' : 'variance-ub';
            const riskId = `risk-${index}`;

            riskHtml += `
                <div class="risk-row risk-expandable" onclick="toggleRiskDetail('${riskId}')">
                    <div class="font-semibold">
                        ${risk.jobId}
                        <svg class="risk-expand-icon" id="${riskId}-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </div>
                    <div class="text-gray-400">${risk.riskTags}</div>
                    <div><span class="risk-level ${levelClass}">${risk.riskLevelLabel}</span></div>
                    <div class="font-semibold ${varianceClass}">${risk.amountAbs}</div>
                </div>
                <div class="risk-details" id="${riskId}-details">
                    <strong>Job ${risk.jobId} Risk Analysis:</strong><br/>
                    Risk Factors: ${risk.riskTags || 'General billing variance'}<br/>
                    ${risk.ubobType === 'OB' ? 
                        `This job shows overbilling of ${risk.amountAbs}. This indicates that billings exceed the percentage of completion, which may require adjustment or present cash flow advantages.` :
                        `This job shows underbilling of ${risk.amountAbs}. Revenue recognition may be lagging behind actual work completed, potentially impacting cash flow.`
                    }<br/>
                    Recommended Action: ${risk.riskLevel === 'high' ? 
                        'Immediate review recommended to assess billing accuracy and project status.' :
                        'Monitor closely and review at next reporting period.'
                    }
                </div>
            `;
        });

        // Generate WIP Summary text
        const totalJobs = data.clean_table ? data.clean_table.length : 0;
        const highRiskCount = risks.filter(r => r.riskLevel === 'high').length;
        const summaryText = `
            Portfolio contains ${totalJobs} active jobs with a combined contract value of ${metrics.total_contract?.value || 'N/A'}. 
            The overall portfolio health shows ${highRiskCount > 3 ? 'elevated risk levels' : 'moderate risk exposure'} with 
            ${highRiskCount} high-priority items requiring immediate attention. 
            ${metrics.gp_percent?.value ? `Current gross profit margin stands at ${metrics.gp_percent.value}, ` : ''}
            ${metrics.wip_gp_percent?.value && metrics.wip_gp_percent.value !== 'N/A' ? 
                `with WIP-adjusted margin at ${metrics.wip_gp_percent.value}.` : 
                'with WIP adjustments pending validation.'
            }
        `;

        return `
            <div class="widget-card">
                <div class="widget-header" id="dashboard-header">
                    <span class="font-semibold">WIP Health Summary</span>
                    <svg id="dashboard-content-icon" class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div class="widget-content" id="dashboard-content">
                    <div class="wip-summary">
                        <h4>Portfolio Overview</h4>
                        <p>${summaryText}</p>
                    </div>
                    
                    ${kpiHtml ? `
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-400 mb-3">KEY METRICS</h4>
                            <div class="kpi-grid">${kpiHtml}</div>
                        </div>
                    ` : ''}
                    
                    ${riskHtml ? `
                        <div>
                            <h4 class="text-sm font-semibold text-gray-400 mb-3">TOP RISKS</h4>
                            <div class="risk-table">
                                <div class="risk-header">
                                    <div>Job ID</div>
                                    <div>Risk Type</div>
                                    <div>Level</div>
                                    <div>
                                        <span class="variance-ob">Over</span> / <span class="variance-ub">Under</span> Billings
                                    </div>
                                </div>
                                ${riskHtml}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function toggleRiskDetail(riskId) {
        const details = document.getElementById(riskId + '-details');
        const icon = document.getElementById(riskId + '-icon');
        
        if (details.classList.contains('expanded')) {
            details.classList.remove('expanded');
            icon.classList.remove('expanded');
        } else {
            details.classList.add('expanded');
            icon.classList.add('expanded');

            // Ensure parent widget-content can grow when a Top Risk is expanded
            const widgetContent = details.closest('.widget-content');
            if (widgetContent && !widgetContent.classList.contains('collapsed')) {
                widgetContent.style.maxHeight = 'none';
            }
        }
    }

    function renderTableWidget(cleanTable) {
        let tableRows = '';
        cleanTable.forEach(job => {
            const obUbValue = (job.over_billing > 0 ? job.over_billing : job.under_billing) || 0;
            const obUbClass = job.over_billing > 0 ? 'variance-ob' : (job.under_billing > 0 ? 'variance-ub' : '');
            const obUbLabel = job.over_billing > 0 ? 'OB' : (job.under_billing > 0 ? 'UB' : '--');

            tableRows += `
                <tr>
                    <td>${job.job_id}</td>
                    <td class="text-right">$${formatNumber(job.contract_amount)}</td>
                    <td class="text-right">$${formatNumber(job.est_cost)}</td>
                    <td class="text-right">$${formatNumber(job.billed_to_date)}</td>
                    <td class="text-right">${(job.percent_complete * 100).toFixed(1)}%</td>
                    <td class="text-right ${obUbClass}">
                        $${formatNumber(obUbValue)} (${obUbLabel})
                    </td>
                </tr>
            `;
        });

        return `
            <div class="widget-card">
                <div class="widget-header" id="table-header">
                    <span class="font-semibold">Full Extracted Data (${cleanTable.length} Jobs)</span>
                    <svg id="table-content-icon" class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div class="widget-content" id="table-content" style="padding: 0;">
                    <div class="data-table" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th class="text-right">Contract</th>
                                    <th class="text-right">Est. Cost</th>
                                    <th class="text-right">Billed</th>
                                    <th class="text-right">POC</th>
                                    <th class="text-right">UB/OB</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function formatNumber(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
</script>
</body>
</html>
